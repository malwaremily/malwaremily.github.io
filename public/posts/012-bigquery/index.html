<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Using BigQuery CLI for Honeypot Log Analysis | malwaremily</title><meta name=keywords content="bigquery,GCP,honeypot,gcloud,SQL,log"><meta name=description content="Learn BitQuery basics using a simple password attempt log."><meta name=author content="malwaremily"><link rel=canonical href=https://malwaremily.com/posts/012-bigquery/><meta name=google-site-verification content="G-ZSJEE4YGQQ"><link href=/assets/css/stylesheet.min.2a79645f388444ef452f62dadbadeebdfebba13b08d1b841a7504a7be022e74d.css integrity="sha256-KnlkXziERO9FL2La263uvf67oTsI0bhBp1BKe+Ai500=" rel="preload stylesheet" as=style><link rel=icon href=https://malwaremily.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://malwaremily.com/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://malwaremily.com/favicon.ico><link rel=apple-touch-icon href=https://malwaremily.com/favicon.ico><link rel=mask-icon href=https://malwaremily.com/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.80.0"><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','G-ZSJEE4YGQQ','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><meta property="og:title" content="Using BigQuery CLI for Honeypot Log Analysis"><meta property="og:description" content="Learn BitQuery basics using a simple password attempt log."><meta property="og:type" content="article"><meta property="og:url" content="https://malwaremily.com/posts/012-bigquery/"><meta property="og:image" content="https://malwaremily.com/img/012-SQLquery.png"><meta property="article:published_time" content="2021-02-09T00:00:03+00:00"><meta property="article:modified_time" content="2021-02-09T00:00:03+00:00"><meta property="og:site_name" content="malwaremily"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://malwaremily.com/img/012-SQLquery.png"><meta name=twitter:title content="Using BigQuery CLI for Honeypot Log Analysis"><meta name=twitter:description content="Learn BitQuery basics using a simple password attempt log."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Using BigQuery CLI for Honeypot Log Analysis","name":"Using BigQuery CLI for Honeypot Log Analysis","description":"Curious about BigQuery? This super quick tutorial will help you get started. BigQuery is a Google Cloud Platform service that provides serverless, scalable data analysis fast. This …","keywords":["bigquery","GCP","honeypot","gcloud","SQL","log"],"articleBody":"Curious about BigQuery? This super quick tutorial will help you get started. BigQuery is a Google Cloud Platform service that provides serverless, scalable data analysis fast. This tutorial will discuss the basics of working with BigQuery including how to create datasets and tables, upload information to them, and how to make queries using the BigQuery command-line interface tool bq.\nPre-Config In order to follow along, you’ll need to have done the following:\n Install Google SDK components Authenticate a connection to your GCP Account Be familiar with SQL Statements  Create a Temporary Project Create a temporary project while you get familiar with BigQuery. Think of a project as a container object that will hold all GCP resources assigned to it. The PROJECT_ID is the name of the project and it will need to be a unique value not in use by any project in existence. For example, I found PROJECT_ID “sample” was already taken but found “sample01” was available.\ngcloud projects list gcloud projects create PROJECT_ID Once the project creation is successful, verify by listing your current working projects. Then set the current working project to your new PROJECT_ID.\ngcloud projects list gcloud config project set PROJECT_ID Create a new Dataset First, we’ll create a new dataset named sample.\n$bq mk sample Dataset 'PROJECT_ID:sample' successfully created. Upload a Table Now its time to upload data to a table for analysis. In a previous post I mentioned parsing the docker logs to pull information about source-ip addresses and username and password attempts made by attacking entities using egrep and sed. For this exercise we’ll use my public gist. Download this file and upload the data to a table in your dataset using the command pattern bq load DATASET_ID.TABLE_ID FILENAME FIELD1:DATA_TYPE, as shown below.\n$bq load sample.passwords passwords.txt password:string Upload complete. Waiting on bqjob_r4c9403a495b4f4ad_00000177757b1dc7_1 ... (0s) Current status: DONE View the available tables in dataset sample.\n$bq ls sample tableId Type Labels Time Partitioning Clustered Fields ----------- ------- -------- ------------------- ------------------ passwords TABLE And view the table schema you created for represented earlier as FIELD1:DATATYPE.\n$bq show sample.passwords Table malwaremily:sample.passwords Last modified Schema Total Rows Total Bytes Expiration Time Partitioning Clustered Fields Labels ----------------- --------------------- ------------ ------------- ------------ ------------------- ------------------ -------- 05 Feb 22:55:41 |- password: string 537 3329 Run Queries Woo! We can run some queries to pull information. Queries can be made with the general pattern bq query \"SQL_STATEMENT\".\nTop 10 most commen password attempts We can count the top 10 password occurrences with COUNT.\n$bq query \"SELECT COUNT(password) AS PASS_COUNT, password FROM sample.passwords GROUP BY password ORDER BY PASS_COUNT DESC LIMIT 10\" Waiting on bqjob_r21d3499c472ace56_0000017782fd4af8_1 ... (0s) Current status: DONE +------------+-----------+ | PASS_COUNT | password | +------------+-----------+ | 61 | password | | 49 | 1 | | 36 | P | | 30 | root | | 26 | A | | 22 | admin | | 20 | 123456 | | 14 | p | | 14 | 123 | | 8 | raspberry | +------------+-----------+ We can pull the top 10 most common password attempts using the COUNT, GROUP, ORDER, DESC and LIMIT keywords. COUNT will count the occurrence of each password and save the related values in column PASS_COUNT. The GROUP keyword allow us to group by passwords and then ORDER the results by PASS_COUNT in descending order with DESC. We limit the number of results returned with LIMIT.\nYou may be wondering why we order the results by column password and not by the custom aggregate PASS_COUNT. The reason for this is because the default SQL used by bq does not allow grouping by an aggregate. This is demonstrated in the query below.\nbq query \"SELECT COUNT(password) AS PASS_COUNT, password FROM sample.passwords GROUP BY PASS_COUNT ORDER BY password DESC LIMIT 10\" The error reads Cannot group by an aggregate. Consider using SQL, which allows grouping by any expression. But aren’t we using SQL already? Well, yes but BigQuery differentiates between standard SQL and legacy SQL dialect. What is the default? Right now, it depends on how you access BigQuery.\nGCP documentation reads, “In the Cloud Console and the client libraries, standard SQL is the default. In the bq command-line tool and the REST API, legacy SQL is the default.” Some searching on public forums like StackOverflow suggest that Standard SQL offers a better experience with less ‘gotchas’ than traditional SQL. While this post uses the default legacy SQL, standard SQL can be enabled for the BigQuery command-line interface. To do so, read the “Setting standard SQL as the defualt for the command-line tool” from the GCP documentation.\nDelete your test environment Once you’re done with the project the environment should be deleted.\ngcloud projects delete PROJECT_ID If you would like to only delete the dataset, you can do so with the following command:\nbq rm -r sample Next Steps For more information about getting started with the bq cli check out this google tutorial where you will use a sample Shakespeare dataset provided by google. If you’d like to automate this behavior then you might be interested in learning more about the C#, Go, Java, Node.js, PHP, Python and/or Ruby client libraries.\n ","wordCount":"857","inLanguage":"en","image":"https://malwaremily.com/img/012-SQLquery.png","datePublished":"2021-02-09T00:00:03Z","dateModified":"2021-02-09T00:00:03Z","author":{"@type":"Person","name":"malwaremily"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://malwaremily.com/posts/012-bigquery/"},"publisher":{"@type":"Organization","name":"malwaremily","logo":{"@type":"ImageObject","url":"https://malwaremily.com/favicon.ico"}}}</script></head><body id=top><script>if(localStorage.getItem("pref-theme")==="dark"){document.body.classList.add('dark');}else if(localStorage.getItem("pref-theme")==="light"){document.body.classList.remove('dark')}else if(window.matchMedia('(prefers-color-scheme: dark)').matches){document.body.classList.add('dark');}</script><noscript><style type=text/css>.theme-toggle,.top-link{display:none}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://malwaremily.com/ accesskey=h title="Home (Alt + H)"><img src=coffeaarabica400x400.png alt=logo aria-label=logo height=35>Home</a>
<span class=logo-switches><span class=theme-toggle title="(Alt + T)"><a id=theme-toggle accesskey=t><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></a></span></span></div><ul class=menu id=menu onscroll=menu_on_scroll()><li><a href=https://malwaremily.com/about/ title=ABOUT><span>ABOUT</span></a></li><li><a href=https://malwaremily.com/archives/ title=ARCHIVES><span>ARCHIVES</span></a></li><li><a href=https://malwaremily.com/search/ title="SEARCH (Alt + /)" accesskey=/><span>SEARCH</span></a></li><li><a href=https://malwaremily.com/tags/ title=TAGS><span>TAGS</span></a></li><li><a href=https://malwaremily.com title=HOME><span>HOME</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Using BigQuery CLI for Honeypot Log Analysis</h1><div class=post-description>Learn BitQuery basics using a simple password attempt log.</div><div class=post-meta>February 9, 2021&nbsp;·&nbsp;5 min</div></header><figure class=entry-cover><img src=https://malwaremily.com/img/012-SQLquery.png alt="Image from Blog - String Table"><p></p></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><div class=details>Table of Contents</div></summary><blockquote><ul><li><a href=#pre-config aria-label=Pre-Config>Pre-Config</a><ul><li><a href=#create-a-temporary-project aria-label="Create a Temporary Project">Create a Temporary Project</a></li><li><a href=#create-a-new-dataset aria-label="Create a new Dataset">Create a new Dataset</a></li><li><a href=#upload-a-table aria-label="Upload a Table">Upload a Table</a></li><li><a href=#run-queries aria-label="Run Queries">Run Queries</a><ul><li><a href=#top-10-most-commen-password-attempts aria-label="Top 10 most commen password attempts">Top 10 most commen password attempts</a></li></ul></li><li><a href=#delete-your-test-environment aria-label="Delete your test environment">Delete your test environment</a></li><li><a href=#next-steps aria-label="Next Steps">Next Steps</a></li></ul></li></ul></blockquote></details></div><div class=post-content><p>Curious about BigQuery? This <em>super quick</em> tutorial will help you get started. BigQuery is a Google Cloud Platform service that provides serverless, scalable data analysis <em>fast</em>. This tutorial will discuss the basics of working with <a href=https://cloud.google.com/bigquery/docs/introduction>BigQuery</a> including how to create datasets and tables, upload information to them, and how to make queries using the BigQuery command-line interface tool <code>bq</code>.</p><h1 id=pre-config>Pre-Config<a hidden class=anchor aria-hidden=true href=#pre-config>#</a></h1><p>In order to follow along, you&rsquo;ll need to have done the following:</p><ul><li><a href=https://cloud.google.com/sdk/docs/install>Install Google SDK components</a></li><li>Authenticate a connection to your GCP Account</li><li>Be familiar with <a href=https://www.w3schools.com/sql/>SQL Statements</a></li></ul><h2 id=create-a-temporary-project>Create a Temporary Project<a hidden class=anchor aria-hidden=true href=#create-a-temporary-project>#</a></h2><p>Create a temporary project while you get familiar with BigQuery. Think of a project as a container object that will hold all GCP resources assigned to it. The <code>PROJECT_ID</code> is the name of the project and it will need to be a unique value not in use by any project in existence. For example, I found <code>PROJECT_ID</code> &ldquo;sample&rdquo; was already taken but found &ldquo;sample01&rdquo; was available.</p><pre><code>gcloud projects list
gcloud projects create PROJECT_ID
</code></pre><p>Once the project creation is successful, verify by listing your current working projects. Then set the current working project to your new <code>PROJECT_ID</code>.</p><pre><code>gcloud projects list
gcloud config project set PROJECT_ID
</code></pre><h2 id=create-a-new-dataset>Create a new Dataset<a hidden class=anchor aria-hidden=true href=#create-a-new-dataset>#</a></h2><p>First, we&rsquo;ll create a new dataset named sample.</p><pre><code>$bq mk sample
Dataset 'PROJECT_ID:sample' successfully created.
</code></pre><h2 id=upload-a-table>Upload a Table<a hidden class=anchor aria-hidden=true href=#upload-a-table>#</a></h2><p>Now its time to upload data to a table for analysis. In a <a href=https://www.malwaremily.com/posts/005-honeypots-cloud/#script>previous post</a> I mentioned parsing the docker logs to pull information about source-ip addresses and username and password attempts made by attacking entities using <code>egrep</code> and <code>sed</code>. For this exercise we&rsquo;ll use my <a href=https://gist.github.com/malwaremily/4948c56665c163e2d0e63b2e2e9eb85a>public gist</a>. Download this file and upload the data to a table in your dataset using the command pattern <code>bq load DATASET_ID.TABLE_ID FILENAME FIELD1:DATA_TYPE</code>, as shown below.</p><pre><code>$bq load sample.passwords passwords.txt password:string
Upload complete.
Waiting on bqjob_r4c9403a495b4f4ad_00000177757b1dc7_1 ... (0s) Current status: DONE 
</code></pre><p>View the available tables in dataset <code>sample</code>.</p><pre><code>$bq ls sample
   tableId    Type    Labels   Time Partitioning   Clustered Fields  
 ----------- ------- -------- ------------------- ------------------ 
  passwords   TABLE  
</code></pre><p>And view the table schema you created for represented earlier as <code>FIELD1:DATATYPE</code>.</p><pre><code>$bq show sample.passwords
Table malwaremily:sample.passwords

   Last modified          Schema          Total Rows   Total Bytes   Expiration   Time Partitioning   Clustered Fields   Labels  
 ----------------- --------------------- ------------ ------------- ------------ ------------------- ------------------ -------- 
  05 Feb 22:55:41   |- password: string   537          3329  
</code></pre><h2 id=run-queries>Run Queries<a hidden class=anchor aria-hidden=true href=#run-queries>#</a></h2><p>Woo! We can run some queries to pull information. Queries can be made with the general pattern <code>bq query "SQL_STATEMENT"</code>.</p><h3 id=top-10-most-commen-password-attempts>Top 10 most commen password attempts<a hidden class=anchor aria-hidden=true href=#top-10-most-commen-password-attempts>#</a></h3><p>We can count the top 10 password occurrences with <code>COUNT</code>.</p><pre><code>$bq query &quot;SELECT COUNT(password) AS PASS_COUNT, password FROM sample.passwords GROUP BY password ORDER BY PASS_COUNT DESC LIMIT 10&quot;
Waiting on bqjob_r21d3499c472ace56_0000017782fd4af8_1 ... (0s) Current status: DONE   
+------------+-----------+
| PASS_COUNT | password  |
+------------+-----------+
|         61 | password  |
|         49 | 1         |
|         36 | P         |
|         30 | root      |
|         26 | A         |
|         22 | admin     |
|         20 | 123456    |
|         14 | p         |
|         14 | 123       |
|          8 | raspberry |
+------------+-----------+
</code></pre><p>We can pull the top 10 most common password attempts using the <code>COUNT</code>, <code>GROUP</code>, <code>ORDER</code>, <code>DESC</code> and <code>LIMIT</code> keywords. <code>COUNT</code> will count the occurrence of each password and save the related values in column <code>PASS_COUNT</code>. The <code>GROUP</code> keyword allow us to group by passwords and then <code>ORDER</code> the results by <code>PASS_COUNT</code> in descending order with <code>DESC</code>. We limit the number of results returned with <code>LIMIT</code>.</p><p>You may be wondering why we order the results by column <code>password</code> and not by the custom aggregate <code>PASS_COUNT</code>. The reason for this is because the default SQL used by <code>bq</code> does not allow grouping by an aggregate. This is demonstrated in the query below.</p><pre><code>bq query &quot;SELECT COUNT(password) AS PASS_COUNT, password FROM sample.passwords GROUP BY PASS_COUNT ORDER BY password DESC LIMIT 10&quot;
</code></pre><p><img src=012-error.png alt="Failed Query"></p><p>The error reads <code>Cannot group by an aggregate. Consider using SQL, which allows grouping by any expression.</code> But aren&rsquo;t we using SQL already? Well, yes but BigQuery differentiates between <a href=https://cloud.google.com/bigquery/docs/reference/standard-sql/functions-and-operators>standard SQL</a> and <a href=https://cloud.google.com/bigquery/docs/reference/legacy-sql>legacy SQL</a> dialect. What is the default? Right now, it depends on how you access BigQuery.</p><p>GCP documentation reads, &ldquo;In the Cloud Console and the client libraries, standard SQL is the default. In the bq command-line tool and the REST API, legacy SQL is the default.&rdquo; Some searching on public forums like <a href=https://stackoverflow.com/questions/43111983/standard-or-legacy-sql-for-google-analytics-data-in-bigquery>StackOverflow</a> suggest that Standard SQL offers a better experience with less &lsquo;gotchas&rsquo; than traditional SQL. While this post uses the default legacy SQL, standard SQL can be enabled for the BigQuery command-line interface. To do so, read the &ldquo;<a href=https://cloud.google.com/bigquery/docs/reference/standard-sql/enabling-standard-sql>Setting standard SQL as the defualt for the command-line tool</a>&rdquo; from the GCP documentation.</p><h2 id=delete-your-test-environment>Delete your test environment<a hidden class=anchor aria-hidden=true href=#delete-your-test-environment>#</a></h2><p>Once you&rsquo;re done with the project the environment should be deleted.</p><pre><code>gcloud projects delete PROJECT_ID
</code></pre><p>If you would like to only delete the dataset, you can do so with the following command:</p><pre><code>bq rm -r sample
</code></pre><h2 id=next-steps>Next Steps<a hidden class=anchor aria-hidden=true href=#next-steps>#</a></h2><p>For more information about getting started with the <code>bq</code> cli check out this <a href=https://cloud.google.com/bigquery/docs/quickstarts/quickstart-command-line>google tutorial</a> where you will use a sample Shakespeare dataset provided by google. If you&rsquo;d like to automate this behavior then you might be interested in learning more about the C#, Go, Java, Node.js, PHP, Python and/or Ruby <a href=https://cloud.google.com/bigquery/docs/quickstarts/quickstart-client-libraries#client-libraries-install-go>client libraries</a>.</p><hr></div><footer class=post-footer><ul class=post-tags><li><a href=https://malwaremily.com/tags/bigquery/>bigquery</a></li><li><a href=https://malwaremily.com/tags/gcp/>GCP</a></li><li><a href=https://malwaremily.com/tags/honeypot/>honeypot</a></li><li><a href=https://malwaremily.com/tags/gcloud/>gcloud</a></li><li><a href=https://malwaremily.com/tags/sql/>SQL</a></li><li><a href=https://malwaremily.com/tags/log/>log</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2021 <a href=https://malwaremily.com/>malwaremily</a></span>
<span>&#183;</span>
<span>Made with ♥ by Emily</span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>window.onload=function(){if(localStorage.getItem("menu-scroll-position")){document.getElementById('menu').scrollLeft=localStorage.getItem("menu-scroll-position");}}
document.querySelectorAll('a[href^="#"]').forEach(anchor=>{anchor.addEventListener("click",function(e){e.preventDefault();var id=this.getAttribute("href").substr(1);if(!window.matchMedia('(prefers-reduced-motion: reduce)').matches){document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({behavior:"smooth"});}else{document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();}
if(id==="top"){history.replaceState(null,null," ");}else{history.replaceState(null,null,`#${id}`);}});});var mybutton=document.getElementById("top-link");window.onscroll=function(){if(document.body.scrollTop>800||document.documentElement.scrollTop>800){mybutton.style.visibility="visible";mybutton.style.opacity="1";}else{mybutton.style.visibility="hidden";mybutton.style.opacity="0";}};function menu_on_scroll(){localStorage.setItem("menu-scroll-position",document.getElementById('menu').scrollLeft);}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{if(document.body.className.includes("dark")){document.body.classList.remove('dark');localStorage.setItem("pref-theme",'light');}else{document.body.classList.add('dark');localStorage.setItem("pref-theme",'dark');}})</script></body></html>