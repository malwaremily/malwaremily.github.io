<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Writing my first forensic tool in Go | malwaremily</title><meta name=keywords content="penut,Go,debug/pe,digital forensics,DFIR"><meta name=description content="Learning more about the debug/pe package."><meta name=author content="malwaremily"><link rel=canonical href=https://malwaremily.com/posts/001-penut/><meta name=google-site-verification content="G-ZSJEE4YGQQ"><link href=/assets/css/stylesheet.min.2a79645f388444ef452f62dadbadeebdfebba13b08d1b841a7504a7be022e74d.css integrity="sha256-KnlkXziERO9FL2La263uvf67oTsI0bhBp1BKe+Ai500=" rel="preload stylesheet" as=style><link rel=icon href=https://malwaremily.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://malwaremily.com/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://malwaremily.com/favicon.ico><link rel=apple-touch-icon href=https://malwaremily.com/favicon.ico><link rel=mask-icon href=https://malwaremily.com/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.80.0"><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','G-ZSJEE4YGQQ','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><meta property="og:title" content="Writing my first forensic tool in Go"><meta property="og:description" content="Learning more about the debug/pe package."><meta property="og:type" content="article"><meta property="og:url" content="https://malwaremily.com/posts/001-penut/"><meta property="og:image" content="https://malwaremily.com/img/001-fileheaderraw.png"><meta property="article:published_time" content="2021-01-20T00:00:03+00:00"><meta property="article:modified_time" content="2021-01-20T00:00:03+00:00"><meta property="og:site_name" content="malwaremily"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://malwaremily.com/img/001-fileheaderraw.png"><meta name=twitter:title content="Writing my first forensic tool in Go"><meta name=twitter:description content="Learning more about the debug/pe package."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Writing my first forensic tool in Go","name":"Writing my first forensic tool in Go","description":"Overview While reading Hands On System Programming with Go, I discovered the debug/pe package. To learn more about using Go I decided to spend a few days building a static forensic …","keywords":["penut","Go","debug/pe","digital forensics","DFIR"],"articleBody":"Overview While reading Hands On System Programming with Go, I discovered the debug/pe package. To learn more about using Go I decided to spend a few days building a static forensic tool centered around use of this package. The debug/pe package provides functions that make analyzing a PE file easier. A glimpse of promising functions include: Open, ImportedLibraries, FileHeader, OpentionHeader32/64, and StringTable. Limiting myself to a span of a week, I’m reporting on functions I’ve applied to penut, a simple PE file static analysis tool, and what the next steps are to build upon the application.\nThe debug/pe Package Load PE file for analysis pe.Open() will load your executable and prep it for use as type *File. A File has the following struct:\ntype File struct { FileHeader OptionalHeader interface{} // of type *OptionalHeader32 or *OptionalHeader64; added in Go 1.3 Sections []*Section Symbols []*Symbol // COFF symbols with auxiliary symbol records removed; added in Go 1.1 COFFSymbols []COFFSymbol // all COFF symbols (including auxiliary symbol records); added in Go 1.8 StringTable StringTable // Go 1.8 // contains filtered or unexported fields } This is significant because it suggests that bare details of the executable are already available to the operator, ready to print to screen. Here is an example of pe.Open within the content of the application.\n\tpfile, err := pe.Open(os.Args[1]) if err != nil { fmt.Fprintf(os.Stderr, \"pe.Open:%s\\n\", err) os.Exit(1) } defer pfile.Close() Sections As shown in the File struct above, we have access to Sections []*Section. This suggests we should be able to output some information related to PE sections. Sections are a basic unit of code or data within a Portable Executable (PE) or Common Object File Format (COFF) file. Section contents vary by section type; each section could occupied by a function or an object, and images make up multiple sections. Some sections serve special purposes, such as .idata, which stores all imported symbols.\nfunc printSections(f *pe.File) { fmt.Println(\"Sections:\\n\") for _, s := range f.Sections { fmt.Printf(\"%s\\n\", s.Name) fmt.Printf(\"%0#8x %s\\n\", s.VirtualSize, \"Virtual Size\") fmt.Printf(\"%0#8x %s\\n\", s.VirtualAddress, \"Virtual Address\") fmt.Printf(\"%0#8x %s\\n\", s.Size, \"Size\") fmt.Printf(\"%0#8x %s\\n\", s.Offset, \"Offset\") fmt.Printf(\"%0#8x %s\\n\", s.PointerToRelocations, \"Pointer To Relocations\") fmt.Printf(\"%0#8x %s\\n\", s.PointerToLineNumbers, \"Pointer to Line Numbers\") fmt.Printf(\"%0#8x %s\\n\", s.NumberOfRelocations, \"Number of Relocations\") fmt.Printf(\"%0#8x %s\\n\", s.NumberOfLineNumbers, \"Number of Line Numbers\") fmt.Printf(\"%0#8x %s\\n\", s.Characteristics, \"Characteristics\") fmt.Println() } } The beautiful code in the snippet above was made avaliable by joesephspurrier. Here is a portion of the resulting output:\n$go run main.go main.exe Sections: .idata 0x000003fc Virtual Size 0x001fb000 Virtual Address 0x00000400 Size 0x001dd000 Offset 0x00000000 Pointer To Relocations 0x00000000 Pointer to Line Numbers 0x00000000 Number of Relocations 0x00000000 Number of Line Numbers 0xc0000040 Characteristics .reloc 0x0000d6a8 Virtual Size 0x001fc000 Virtual Address 0x0000d800 Size 0x001dd400 Offset 0x00000000 Pointer To Relocations 0x00000000 Pointer to Line Numbers 0x00000000 Number of Relocations 0x00000000 Number of Line Numbers 0x42000040 Characteristics Next Steps Right now, the main.go file must be modified to obtain any information, not much of it actionable. If I were to continue to work on penut I would like to output the results to a report and instead print a summary out after running penut. As I continued to experiment with the available types, structs, and functions provided by debug/pe I found that I would need to better famliarize myself with the Go language in order to digest and parse the information provided by the pe package.\nFile Header We can, for instance, pull File Header information from the new File instance pfile. The code below is an example of a function that would read in pfile and print out the File Header information.\nfunc printFileHeader(f *pe.File) { a := f.FileHeader fmt.Print(\"File Header: \") fmt.Println(a) } And the resulting output:\n$go run main.go main.exe File Header: {332 15 0 2010112 3392 224 770} Looking at the above output of printFileHeader() we see the value of the pfile OptionalHeader interface{}. Microsoft Docs writes, “the PE file header consists of a Microsoft MS-DOS stub, the PE signature, the COFF file header, and an optional header. A COFF object file header consists of a COFF file header and an optional header.” The output of f.FileHeader consists of 7 values, inconsistent with the 4 values aforementioned (MS-DOS stub, PE signature, COEFF file header, optional header). So what are we seeing here? I’m not yet sure.\nString Table As another example, the StringTable attribute prints out what seems to be a LONG string of bytes.\nfunc printStringTable(f *pe.File) { a := f.StringTable fmt.Println(a) } This long string of bytes can be cast into a string for human reading.\nfunc printStringTable(f *pe.File) { a := string(f.StringTable) fmt.Println(a) } The long string appears to be deliniated by a period .. By itself, the data is not yet actionable, but you can look over the strings output a little easier by replacing the periods with newlines, as shown in the code and output below.\nfunc printStringTable(f *pe.File) { a := string(f.StringTable) b := strings.Replace(a, \".\", \"\\n\", -1) fmt.Println(b) } [ … ] Conclusion While penut is far from being a functional static analysis tool, it was fun to experiment with the Go debug/pe package for a few days. If you would like to see a working solution check out soluwalana’s go-pefile github repo.\n Thanks for reading! I hope you found the information educational. For even more information, see the following references:\n https://golang.org/pkg/debug/pe/ https://en.wikipedia.org/wiki/Portable_Executable https://docs.microsoft.com/en-us/windows/win32/debug/pe-format#file-headers https://github.com/coffeefolia/penut  ","wordCount":"888","inLanguage":"en","image":"https://malwaremily.com/img/001-fileheaderraw.png","datePublished":"2021-01-20T00:00:03Z","dateModified":"2021-01-20T00:00:03Z","author":{"@type":"Person","name":"malwaremily"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://malwaremily.com/posts/001-penut/"},"publisher":{"@type":"Organization","name":"malwaremily","logo":{"@type":"ImageObject","url":"https://malwaremily.com/favicon.ico"}}}</script></head><body id=top><script>if(localStorage.getItem("pref-theme")==="dark"){document.body.classList.add('dark');}else if(localStorage.getItem("pref-theme")==="light"){document.body.classList.remove('dark')}else if(window.matchMedia('(prefers-color-scheme: dark)').matches){document.body.classList.add('dark');}</script><noscript><style type=text/css>.theme-toggle,.top-link{display:none}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://malwaremily.com/ accesskey=h title="Home (Alt + H)"><img src=coffeaarabica400x400.png alt=logo aria-label=logo height=35>Home</a>
<span class=logo-switches><span class=theme-toggle title="(Alt + T)"><a id=theme-toggle accesskey=t><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></a></span></span></div><ul class=menu id=menu onscroll=menu_on_scroll()><li><a href=https://malwaremily.com/about/ title=ABOUT><span>ABOUT</span></a></li><li><a href=https://malwaremily.com/archives/ title=ARCHIVES><span>ARCHIVES</span></a></li><li><a href=https://malwaremily.com/search/ title="SEARCH (Alt + /)" accesskey=/><span>SEARCH</span></a></li><li><a href=https://malwaremily.com/tags/ title=TAGS><span>TAGS</span></a></li><li><a href=https://malwaremily.com title=HOME><span>HOME</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Writing my first forensic tool in Go</h1><div class=post-description>Learning more about the debug/pe package.</div><div class=post-meta>January 20, 2021&nbsp;·&nbsp;5 min</div></header><figure class=entry-cover><img src=https://malwaremily.com/img/001-fileheaderraw.png alt="Image from Blog - String Table"><p></p></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><div class=details>Table of Contents</div></summary><blockquote><ul><ul><li><a href=#overview aria-label=Overview>Overview</a></li></ul><li><a href=#the-debugpe-package aria-label="The debug/pe Package">The <code>debug/pe</code> Package</a><ul><li><a href=#load-pe-file-for-analysis aria-label="Load PE file for analysis">Load PE file for analysis</a></li><li><a href=#sections aria-label=Sections>Sections</a></li></ul></li><li><a href=#next-steps aria-label="Next Steps">Next Steps</a><ul><li><a href=#file-header aria-label="File Header">File Header</a></li><li><a href=#string-table aria-label="String Table">String Table</a></li></ul></li><li><a href=#conclusion aria-label=Conclusion>Conclusion</a></li></ul></blockquote></details></div><div class=post-content><h3 id=overview>Overview<a hidden class=anchor aria-hidden=true href=#overview>#</a></h3><p>While reading Hands On System Programming with Go, I discovered the <code>debug/pe</code> package. To learn more about using Go I decided to spend a few days building a static forensic tool centered around use of this package. The <a href=https://golang.org/pkg/debug/pe/>debug/pe</a> package provides functions that make analyzing a PE file easier. A glimpse of promising functions include: Open, ImportedLibraries, FileHeader, OpentionHeader32/64, and StringTable. Limiting myself to a span of a week, I&rsquo;m reporting on functions I&rsquo;ve applied to <code>penut</code>, a simple PE file static analysis tool, and what the next steps are to build upon the application.</p><h2 id=the-debugpe-package>The <code>debug/pe</code> Package<a hidden class=anchor aria-hidden=true href=#the-debugpe-package>#</a></h2><h3 id=load-pe-file-for-analysis>Load PE file for analysis<a hidden class=anchor aria-hidden=true href=#load-pe-file-for-analysis>#</a></h3><p><code>pe.Open()</code> will load your executable and prep it for use as type *File. A File has the following struct:</p><pre><code>type File struct {
    FileHeader
    OptionalHeader interface{} // of type *OptionalHeader32 or *OptionalHeader64; added in Go 1.3
    Sections       []*Section
    Symbols        []*Symbol    // COFF symbols with auxiliary symbol records removed; added in Go 1.1
    COFFSymbols    []COFFSymbol // all COFF symbols (including auxiliary symbol records); added in Go 1.8
    StringTable    StringTable // Go 1.8
    // contains filtered or unexported fields
}
</code></pre><p>This is significant because it suggests that bare details of the executable are already available to the operator, ready to print to screen. Here is an example of <code>pe.Open</code> within the content of the application.</p><pre><code>	pfile, err := pe.Open(os.Args[1])
	if err != nil {
		fmt.Fprintf(os.Stderr, &quot;pe.Open:%s\n&quot;, err)
		os.Exit(1)
	}
	defer pfile.Close()
</code></pre><h3 id=sections>Sections<a hidden class=anchor aria-hidden=true href=#sections>#</a></h3><p>As shown in the <code>File</code> struct above, we have access to <code>Sections []*Section</code>. This suggests we should be able to output some information related to PE sections. Sections are a basic unit of code or data within a Portable Executable (PE) or Common Object File Format (COFF) file. Section contents vary by section type; each section could occupied by a function or an object, and images make up multiple sections. Some sections serve special purposes, such as .idata, which stores all imported symbols.</p><pre><code>func printSections(f *pe.File) {
	fmt.Println(&quot;Sections:\n&quot;)
	for _, s := range f.Sections {
		fmt.Printf(&quot;%s\n&quot;, s.Name)
		fmt.Printf(&quot;%0#8x %s\n&quot;, s.VirtualSize, &quot;Virtual Size&quot;)
		fmt.Printf(&quot;%0#8x %s\n&quot;, s.VirtualAddress, &quot;Virtual Address&quot;)
		fmt.Printf(&quot;%0#8x %s\n&quot;, s.Size, &quot;Size&quot;)
		fmt.Printf(&quot;%0#8x %s\n&quot;, s.Offset, &quot;Offset&quot;)
		fmt.Printf(&quot;%0#8x %s\n&quot;, s.PointerToRelocations, &quot;Pointer To Relocations&quot;)
		fmt.Printf(&quot;%0#8x %s\n&quot;, s.PointerToLineNumbers, &quot;Pointer to Line Numbers&quot;)
		fmt.Printf(&quot;%0#8x %s\n&quot;, s.NumberOfRelocations, &quot;Number of Relocations&quot;)
		fmt.Printf(&quot;%0#8x %s\n&quot;, s.NumberOfLineNumbers, &quot;Number of Line Numbers&quot;)
		fmt.Printf(&quot;%0#8x %s\n&quot;, s.Characteristics, &quot;Characteristics&quot;)
		fmt.Println()
	}
}
</code></pre><p>The beautiful code in the snippet above was made avaliable by <a href=https://gist.github.com/josephspurrier/120d6f1c87fde4d9769e>joesephspurrier</a>. Here is a portion of the resulting output:</p><pre><code>$go run main.go main.exe
Sections:

.idata
0x000003fc Virtual Size
0x001fb000 Virtual Address
0x00000400 Size
0x001dd000 Offset
0x00000000 Pointer To Relocations
0x00000000 Pointer to Line Numbers
0x00000000 Number of Relocations
0x00000000 Number of Line Numbers
0xc0000040 Characteristics

.reloc
0x0000d6a8 Virtual Size
0x001fc000 Virtual Address
0x0000d800 Size
0x001dd400 Offset
0x00000000 Pointer To Relocations
0x00000000 Pointer to Line Numbers
0x00000000 Number of Relocations
0x00000000 Number of Line Numbers
0x42000040 Characteristics
</code></pre><h2 id=next-steps>Next Steps<a hidden class=anchor aria-hidden=true href=#next-steps>#</a></h2><p>Right now, the <code>main.go</code> file must be modified to obtain any information, not much of it actionable. If I were to continue to work on <code>penut</code> I would like to output the results to a report and instead print a summary out after running <code>penut</code>. As I continued to experiment with the available types, structs, and functions provided by <code>debug/pe</code> I found that I would need to better famliarize myself with the Go language in order to digest and parse the information provided by the <code>pe</code> package.</p><h3 id=file-header>File Header<a hidden class=anchor aria-hidden=true href=#file-header>#</a></h3><p>We can, for instance, pull File Header information from the new File instance <code>pfile</code>. The code below is an example of a function that would read in <code>pfile</code> and print out the File Header information.</p><pre><code>func printFileHeader(f *pe.File) {
	a := f.FileHeader
	fmt.Print(&quot;File Header: &quot;)
	fmt.Println(a)
}
</code></pre><p>And the resulting output:</p><pre><code>$go run main.go main.exe 
File Header: {332 15 0 2010112 3392 224 770}
</code></pre><p>Looking at the above output of <code>printFileHeader()</code> we see the value of the <code>pfile</code> <code>OptionalHeader interface{}</code>. <a href=https://docs.microsoft.com/en-us/windows/win32/debug/pe-format#file-headers>Microsoft Docs</a> writes, &ldquo;the PE file header consists of a Microsoft MS-DOS stub, the PE signature, the COFF file header, and an optional header. A COFF object file header consists of a COFF file header and an optional header.&rdquo; The output of <code>f.FileHeader</code> consists of 7 values, inconsistent with the 4 values aforementioned (MS-DOS stub, PE signature, COEFF file header, optional header). So what are we seeing here? I&rsquo;m not yet sure.</p><h3 id=string-table>String Table<a hidden class=anchor aria-hidden=true href=#string-table>#</a></h3><p>As another example, the StringTable attribute prints out what seems to be a LONG string of bytes.</p><pre><code>func printStringTable(f *pe.File) {
a := f.StringTable
fmt.Println(a)
}
</code></pre><p><img src=/img/001-stringtablebytes.png alt="StringTable Bytes Output"></p><p>This long string of bytes can be cast into a string for human reading.</p><pre><code>func printStringTable(f *pe.File) {
    a := string(f.StringTable)
    fmt.Println(a)
}
</code></pre><p><img src=/img/001-stringtablestring.png alt="StringTable Bytes Cast to String"></p><p>The long string appears to be deliniated by a period <code>.</code>. By itself, the data is not yet actionable, but you can look over the strings output a little easier by replacing the periods with newlines, as shown in the code and output below.</p><pre><code>func printStringTable(f *pe.File) {
	a := string(f.StringTable)
	b := strings.Replace(a, &quot;.&quot;, &quot;\n&quot;, -1)
	fmt.Println(b)
}
</code></pre><p><img src=/img/001-stringtableparseda.png alt="StringTable String Parsed">
[ &mldr; ]
<img src=/img/001-stringtableparsedb.png alt="StringTable String Parsed"></p><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2><p>While <code>penut</code> is far from being a functional static analysis tool, it was fun to experiment with the Go <code>debug/pe</code> package for a few days. If you would like to see a working solution check out soluwalana&rsquo;s <a href=https://github.com/soluwalana/pefile-go>go-pefile</a> github repo.</p><hr><p>Thanks for reading! I hope you found the information educational.
For even more information, see the following references:</p><ul><li><a href=https://golang.org/pkg/debug/pe/>https://golang.org/pkg/debug/pe/</a></li><li><a href=https://en.wikipedia.org/wiki/Portable_Executable>https://en.wikipedia.org/wiki/Portable_Executable</a></li><li><a href=https://docs.microsoft.com/en-us/windows/win32/debug/pe-format#file-headers>https://docs.microsoft.com/en-us/windows/win32/debug/pe-format#file-headers</a></li><li><a href=https://github.com/coffeefolia/penut>https://github.com/coffeefolia/penut</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://malwaremily.com/tags/penut/>penut</a></li><li><a href=https://malwaremily.com/tags/go/>Go</a></li><li><a href=https://malwaremily.com/tags/debug/pe/>debug/pe</a></li><li><a href=https://malwaremily.com/tags/digital-forensics/>digital forensics</a></li><li><a href=https://malwaremily.com/tags/dfir/>DFIR</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2021 <a href=https://malwaremily.com/>malwaremily</a></span>
<span>&#183;</span>
<span>Made with ♥ by Emily</span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>window.onload=function(){if(localStorage.getItem("menu-scroll-position")){document.getElementById('menu').scrollLeft=localStorage.getItem("menu-scroll-position");}}
document.querySelectorAll('a[href^="#"]').forEach(anchor=>{anchor.addEventListener("click",function(e){e.preventDefault();var id=this.getAttribute("href").substr(1);if(!window.matchMedia('(prefers-reduced-motion: reduce)').matches){document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({behavior:"smooth"});}else{document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();}
if(id==="top"){history.replaceState(null,null," ");}else{history.replaceState(null,null,`#${id}`);}});});var mybutton=document.getElementById("top-link");window.onscroll=function(){if(document.body.scrollTop>800||document.documentElement.scrollTop>800){mybutton.style.visibility="visible";mybutton.style.opacity="1";}else{mybutton.style.visibility="hidden";mybutton.style.opacity="0";}};function menu_on_scroll(){localStorage.setItem("menu-scroll-position",document.getElementById('menu').scrollLeft);}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{if(document.body.className.includes("dark")){document.body.classList.remove('dark');localStorage.setItem("pref-theme",'light');}else{document.body.classList.add('dark');localStorage.setItem("pref-theme",'dark');}})</script></body></html>